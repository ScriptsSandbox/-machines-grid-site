<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pier Instrumentation</title>

  <style>
    /* =========================
       Local Fonts (GitHub Pages)
       ========================= */
    @font-face {
      font-family: "Brix Sans";
      src: url("./fonts/HvDTrial_BrixSans-Light-BF64c337930afcd.otf") format("opentype");
      font-weight: 300;
      font-style: normal;
      font-display: swap;
    }
    @font-face {
      font-family: "Brix Sans";
      src: url("./fonts/HvDTrial_BrixSans-Bold-BF64c33792e9cc8.otf") format("opentype");
      font-weight: 700;
      font-style: normal;
      font-display: swap;
    }
    @font-face {
      font-family: "Refrigerator Deluxe";
      src: url("./fonts/Refrigerator Deluxe Heavy.otf") format("opentype");
      font-weight: 800;
      font-style: normal;
      font-display: swap;
    }

    /* =========================
       Theme (Scripps-ish)
       ========================= */
    :root{
      --bg:#ffffff;
      --ink:#0b1220;
      --muted:#8aa0b8;
      --navy:#132a46;
      --navy2:#0f243a;
      --border:rgba(255,255,255,.14);
      --accent:#00b3c7;
      --radius:26px;

      --good:#8bd17c;
      --warn:#ffb020;
      --bad:#ff6b6b;
    }

    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);}
    body{font:16px/1.45 "Brix Sans", system-ui, -apple-system, sans-serif;}
    .wrap{max-width:1200px;margin:0 auto;padding:26px 18px 64px;}

    .bigTitle{
      font-family:"Refrigerator Deluxe", sans-serif;
      text-transform:uppercase;
      letter-spacing:.06em;
      font-size:56px;
      line-height:1.02;
      color:#1b2f49;
      margin:0 0 18px;
    }
    @media (max-width:840px){ .bigTitle{font-size:40px;} }

    /* Header */
    .header{
      border-radius:var(--radius);
      overflow:hidden;
      background:var(--navy2);
      color:#fff;
      box-shadow:0 10px 20px rgba(0,0,0,.08);
    }
    .headTop{
      padding:18px 18px 12px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .headRow{
      display:flex;
      gap:14px;
      align-items:flex-end;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .headKicker{
      text-transform:uppercase;
      letter-spacing:.14em;
      font-weight:700;
      color:rgba(255,255,255,.78);
      font-size:12px;
    }
    .headSelected{
      margin-top:10px;
      font-weight:700;
      color:#fff;
      font-size:18px;
    }

    .controls{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:flex-end;
    }
    .field{display:flex;flex-direction:column;gap:6px;}
    label{
      text-transform:uppercase;
      letter-spacing:.14em;
      font-weight:700;
      color:rgba(255,255,255,.72);
      font-size:11px;
    }
    select,input{
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.16);
      color:#fff;
      border-radius:9999px;
      padding:10px 12px;
      font:700 13px/1 "Brix Sans", system-ui, sans-serif;
      outline:none;
    }
    select option{color:#0b1220;}
    input{min-width:240px}
    @media (max-width:520px){ input{min-width:160px} }

    .btn{
      all:unset;
      cursor:pointer;
      border-radius:9999px;
      padding:10px 14px;
      font-weight:800;
      letter-spacing:.06em;
      text-transform:uppercase;
      font-size:12px;
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.18);
    }
    .btn:hover{background:rgba(255,255,255,.14);}
    .count{
      margin-left:auto;
      color:rgba(255,255,255,.78);
      font-weight:700;
      white-space:nowrap;
    }

    /* Header map */
    .headMap{padding:14px 18px 18px;}
    .mapFrame{
      border-radius:20px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
    }
    .mapInner{padding:12px;}
    .mapSvg{width:100%;height:150px;display:block;}
    @media (max-width:640px){ .mapSvg{height:120px} }

    /* Tiles */
    .grid{
      margin-top:18px;
      display:grid;
      grid-template-columns:repeat(3, 1fr);
      gap:18px;
    }
    @media (max-width:980px){ .grid{grid-template-columns:repeat(2,1fr)} }
    @media (max-width:640px){ .grid{grid-template-columns:1fr} }

    .tile{
      border-radius:var(--radius);
      overflow:hidden;
      background:var(--navy);
      color:#fff;
      box-shadow:0 10px 20px rgba(0,0,0,.10);
      cursor:pointer;
      border:1px solid rgba(255,255,255,.08);
      transform:translateY(0);
      transition:transform 120ms ease, box-shadow 120ms ease;
    }
    .tile:hover{transform:translateY(-1px);box-shadow:0 14px 26px rgba(0,0,0,.14);}
    .tile.sel{outline:4px solid rgba(0,179,199,.35);outline-offset:2px;}

    .tileImg{
      height:170px;
      background:#0b1d33;
      position:relative;
      overflow:hidden;
    }
    .tileImg img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
      opacity:.55;
    }
    .tileImg::after{
      content:"";
      position:absolute;inset:0;
      background:linear-gradient(180deg, rgba(19,42,70,.15), rgba(19,42,70,.86));
    }

    .tileBody{padding:18px 18px 16px;}
    .tileTitle{
      font-family:"Refrigerator Deluxe", sans-serif;
      margin:0;
      letter-spacing:.02em;
      font-size:34px;
      line-height:1.05;
    }
    .tileSub{
      margin-top:10px;
      font-size:18px;
      font-weight:600;
      color:rgba(255,255,255,.88);
      max-width:44ch;
    }
    .tileMeta{
      margin-top:14px;
      font-weight:700;
      color:rgba(255,255,255,.82);
    }

    .rowTop{
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:flex-start;
      flex-wrap:wrap;
    }

    .statusPill{
      display:inline-flex;align-items:center;gap:10px;
      border-radius:9999px;
      padding:9px 12px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.08);
      font-weight:800;
      letter-spacing:.04em;
      text-transform:uppercase;
      font-size:12px;
      white-space:nowrap;
    }
    .dot{width:9px;height:9px;border-radius:50%;background:currentColor;}

    .ctaRow{margin-top:16px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    .cta{
      display:inline-flex;gap:10px;align-items:center;
      padding:10px 14px;
      border-radius:9999px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.08);
      color:#fff;
      font-weight:800;
      letter-spacing:.04em;
      text-transform:uppercase;
      font-size:12px;
      text-decoration:none;
      cursor:pointer;
    }
    .cta.primary{border-color:rgba(0,179,199,.45);background:rgba(0,179,199,.18);}
    .cta:hover{background:rgba(255,255,255,.12);}

    /* Modal */
    .backdrop{
      position:fixed;inset:0;
      background:rgba(11,18,32,.55);
      display:none;align-items:center;justify-content:center;
      padding:18px;
      z-index:50;
    }
    .backdrop.on{display:flex}
    .modal{
      width:min(560px, 100%);
      background:#fff;
      border-radius:18px;
      overflow:hidden;
      box-shadow:0 18px 50px rgba(0,0,0,.35);
      border:1px solid rgba(0,0,0,.10);
      color:#0b1220;
      font-family:"Brix Sans", system-ui, sans-serif;
    }
    .mhead{
      padding:14px 14px;
      border-bottom:1px solid rgba(0,0,0,.10);
      display:flex;justify-content:space-between;gap:12px;align-items:flex-start;
    }
    .mtitle{margin:0;font:800 18px/1.2 "Brix Sans", system-ui, sans-serif;}
    .msub{margin-top:4px;color:#536072;font-weight:600;font-size:13px}
    .close{
      all:unset;cursor:pointer;
      padding:8px 10px;border-radius:10px;
      border:1px solid rgba(0,0,0,.12);
      font-weight:800;font-size:12px;
    }
    .mbody{padding:14px}
    .kv{display:grid;grid-template-columns:140px 1fr;gap:8px 12px;margin-top:8px}
    .k{color:#536072;font-weight:700;font-size:12px;text-transform:uppercase;letter-spacing:.12em}
    .v{font-weight:700}
    .v a{color:#0b66c3;text-decoration:none}
    .v a:hover{text-decoration:underline}

    /* Error */
    .err{
      margin-top:10px;
      color:rgba(255,210,210,.95);
      font-weight:800;
      white-space:pre-wrap;
      max-width:70ch;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h1 class="bigTitle">Monitoring the<br>Pulse of our Planet</h1>

    <section class="header">
      <div class="headTop">
        <div class="headRow">
          <div>
            <div class="headKicker">Pier Instrumentation</div>
            <div id="selectedLine" class="headSelected">Select an instrument to highlight its bent.</div>
            <div id="err" class="err" style="display:none"></div>
          </div>

          <div class="controls">
            <div class="field">
              <label for="classSel">Sensor Class</label>
              <select id="classSel"></select>
            </div>
            <div class="field">
              <label for="statusSel">Status</label>
              <select id="statusSel"></select>
            </div>
            <div class="field">
              <label for="q">Search</label>
              <input id="q" placeholder="Instrument name…" />
            </div>
            <button id="clear" class="btn" type="button">Clear</button>
            <div id="count" class="count">Showing 0</div>
          </div>
        </div>
      </div>

      <div class="headMap">
        <div class="mapFrame">
          <div class="mapInner" id="map"></div>
        </div>
      </div>
    </section>

    <section id="grid" class="grid" aria-label="Instrumentation tiles"></section>
  </div>

  <!-- Owner modal -->
  <div id="backdrop" class="backdrop" role="dialog" aria-modal="true" aria-labelledby="mtitle">
    <div class="modal">
      <div class="mhead">
        <div>
          <h2 id="mtitle" class="mtitle">Owner</h2>
          <div id="msub" class="msub">—</div>
        </div>
        <button id="mclose" class="close" type="button">Close</button>
      </div>
      <div class="mbody">
        <div class="kv">
          <div class="k">PI</div><div id="mpi" class="v">—</div>
          <div class="k">Email</div><div id="memail" class="v">—</div>
          <div class="k">Phone</div><div id="mphone" class="v">—</div>
          <div class="k">PI URL</div><div id="murl" class="v">—</div>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  /* ============================================================
     CSV: fallback if no ?csv= is provided
     ============================================================ */
  const DEFAULT_CSV =
    "https://docs.google.com/spreadsheets/d/e/2PACX-1vTPfuUmpWyeMlzZZrwbGRBYjDdo9gKL1HN9LDfe-OVAfT8xrHHCtRG-q_L4kBSCtUcMkFIQG3J_ydqx/pub?gid=0&single=true&output=csv";

  const PIER_BG_URL = new URL("./pierBACKGROUND.svg", location.href).toString();

  /* ============================================================
     Geometry (from your pier.svg)
     viewBox: 0 0 203.2 31.75
     ============================================================ */
  const OUTLINE_D = `M 16.293881,6.0807658 V 8.6397827 H 9.3667939 V 6.141744 H 4.4518951 V 26.857275 H 9.3667939 V 23.01875 h 6.9270871 v 1.21853 h 8.585337 V 22.210014 H 202.1334 V 10.724927 H 24.879218 V 6.0807658 Z`;

  const X_BY_BENT = [
    4.9879151,8.9228976,12.85788,16.792863,20.727845,24.662828,28.59781,32.532793,36.467775,40.402758,
    44.33774,48.272723,52.207705,56.142688,60.07767,64.01265,67.94763,71.88262,75.8176,79.75258,
    83.68756,87.62254,91.55752,95.4925,99.42748,103.36247,107.29745,111.23243,115.16741,119.10239,
    123.03737,126.97235,130.90733,134.84232,138.7773,142.71228,146.64729,150.58227,154.51725,158.45223,
    162.38722,166.3222,170.25718,174.19216,178.12715,182.06213,185.99711,189.93209,193.86708,197.80206,
    201.73704
  ];
  // Row Y positions (tuned for visual alignment on pierBACKGROUND.svg)
  // Note: smaller Y = higher on the image.
  const Y_A = 9.20;          // moved up slightly (A circle aligns with pier edge)
  const Y_E = 22.872483;     // keep E as-is for now
  const Y_C = (Y_A + Y_E) / 2; // C always centered between A and E
  
  // Move B and D outward (away from the middle) on the narrow end
  // (smaller B = up; larger D = down)
  const Y_B = 11.625;
  const Y_D = 20.975;
  
  const Y_BY_ROW = { A: Y_A, B: Y_B, C: Y_C, D: Y_D, E: Y_E };

  function xForBent(b){
    const bent = Number(b);
    if (!Number.isFinite(bent) || bent < 1 || bent > 51) return X_BY_BENT[0];
    return X_BY_BENT[51 - bent];
  }
  function yForRow(letter){
    const L = String(letter || "").toUpperCase();
    return Y_BY_ROW[L] ?? Y_BY_ROW.C;
  }

  /* ============================================================
     DOM
     ============================================================ */
  const els = {
    grid: document.getElementById("grid"),
    map: document.getElementById("map"),
    selectedLine: document.getElementById("selectedLine"),
    count: document.getElementById("count"),
    err: document.getElementById("err"),

    classSel: document.getElementById("classSel"),
    statusSel: document.getElementById("statusSel"),
    q: document.getElementById("q"),
    clear: document.getElementById("clear"),

    backdrop: document.getElementById("backdrop"),
    mclose: document.getElementById("mclose"),
    mtitle: document.getElementById("mtitle"),
    msub: document.getElementById("msub"),
    mpi: document.getElementById("mpi"),
    memail: document.getElementById("memail"),
    mphone: document.getElementById("mphone"),
    murl: document.getElementById("murl"),
  };

  /* ============================================================
     Helpers
     ============================================================ */
  const norm = (s) => String(s ?? "").trim().toLowerCase().replace(/\s+/g, "_");
  const looksLikeUrl = (s) => /^https?:\/\//i.test(String(s || "").trim());

  function normalizeDriveUrl(u){
    const s = String(u || "").trim();
    if (!looksLikeUrl(s)) return "";

    // Already ideal
    if (s.startsWith("https://lh3.googleusercontent.com/d/")) return s;

    // drive.usercontent.google.com/download?id=FILE_ID...
    if (s.includes("drive.usercontent.google.com")) {
      const m = s.match(/[?&]id=([^&]+)/);
      if (m && m[1]) return `https://lh3.googleusercontent.com/d/${m[1]}`;
    }

    // drive.google.com/file/d/FILE_ID/...
    if (s.includes("drive.google.com")) {
      let id = "";
      const m1 = s.match(/\/file\/d\/([^/]+)/);
      if (m1) id = m1[1];
      const m2 = s.match(/[?&]id=([^&]+)/);
      if (!id && m2) id = m2[1];
      if (id) return `https://lh3.googleusercontent.com/d/${id}`;
    }

    return s;
  }

  function first(obj, keys){
    for (const k of keys){
      const nk = norm(k);
      if (obj[nk] != null && String(obj[nk]).trim() !== "") return String(obj[nk]).trim();
    }
    return "";
  }

  function parseCSV(text){
    const rows=[]; let i=0, field="", row=[], inQ=false;
    const pushF=()=>{ row.push(field); field=""; };
    const pushR=()=>{ rows.push(row); row=[]; };
    while(i<text.length){
      const ch=text[i++];
      if(inQ){
        if(ch === '"'){
          if(text[i] === '"'){ field += '"'; i++; } else inQ=false;
        } else field += ch;
      } else {
        if(ch === '"') inQ=true;
        else if(ch === ',') pushF();
        else if(ch === '\r') {}
        else if(ch === '\n'){ pushF(); pushR(); }
        else field += ch;
      }
    }
    pushF(); if(row.length) pushR();
    if(rows.length < 2) return [];
    const headers = rows[0].map(norm);
    return rows.slice(1)
      .filter(r => r.some(v => String(v||"").trim() !== ""))
      .map(r => {
        const obj={};
        headers.forEach((h,idx)=> obj[h] = (r[idx] ?? "").toString());
        return obj;
      });
  }

  async function fetchText(url){
    const u = new URL(url, location.href);
    if (u.protocol === "http:" || u.protocol === "https:") u.searchParams.set("cb", String(Date.now()));
    const res = await fetch(u.toString(), { cache:"no-cache" });
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const txt = await res.text();
    if (/^\s*</.test(txt)) throw new Error("Got HTML back (not CSV). Make sure the Sheet is Published to web as CSV.");
    return txt;
  }

  function statusColor(s){
    const v = String(s||"").toLowerCase();
    if (/(out\s*of\s*service|down|offline|broken)/.test(v)) return getComputedStyle(document.documentElement).getPropertyValue('--bad') || '#ff6b6b';
    if (/(limited|unauthorized|restricted|degraded)/.test(v)) return getComputedStyle(document.documentElement).getPropertyValue('--warn') || '#ffb020';
    if (/(setup|commission|install)/.test(v)) return getComputedStyle(document.documentElement).getPropertyValue('--accent') || '#00b3c7';
    return getComputedStyle(document.documentElement).getPropertyValue('--good') || '#8bd17c';
  }

  function safeIdFromRow(x, idx){
    const base = `${x.instrumentName||"instrument"}|${x.bentNo||""}${x.bentLetter||""}|${x.sensorClass||""}|${idx}`;
    return base.replace(/[^a-z0-9|_-]+/gi, "_");
  }

  /* ============================================================
     CSV URL resolution (robust to encoded/unencoded)
     ============================================================ */
  function getCsvUrlFromParams(params){
    let url = params.get('csv');
    if (!url) return null;

    // If user pasted an unencoded link and it got split into separate params,
    // re-attach gid/single/output.
    if (!url.includes('?')) {
      const extras = [];
      ['gid','single','output'].forEach(k => {
        const v = params.get(k);
        if (v != null) extras.push(`${k}=${encodeURIComponent(v)}`);
      });
      if (extras.length) url += '?' + extras.join('&');
    }
    return url;
  }

  /* ============================================================
     Mapping from your sheet headers
     ============================================================ */
  function mapRow(r, idx){
    const instrumentName = first(r, ["Instrument Name", "Instrument"]);
    const sensorClass = first(r, ["Sensor Class"]);
    const dataCollected = first(r, ["Data Collected"]);
    const wetDry = first(r, ["Wet or Dry", "Wet/Dry"]);
    const status = first(r, ["Status"]);

    const bentNoRaw = first(r, ["Bent No.", "Bent No"]);
    const bentLetter = String(first(r, ["Bent Letter"]) || "").toUpperCase();
    const mllw = first(r, ["MLLW (m)", "MLLW"]);

    // Prefer directimageURL if present
    const imageRaw = first(r, ["directimageURL", "direct image url", "Image URL", "Image"]);
    const image = normalizeDriveUrl(imageRaw) || (looksLikeUrl(imageRaw) ? imageRaw.trim() : "");

    const urlDataRaw = first(r, ["URL for Data", "Data URL"]);
    const urlData = looksLikeUrl(urlDataRaw) ? urlDataRaw.trim() : "";

    const piName = first(r, ["PI Name or number", "PI"]);
    const phone = first(r, ["Phone"]);
    const email = first(r, ["Email"]);
    const piUrlRaw = first(r, ["URL for PI", "PI URL"]);
    const piUrl = looksLikeUrl(piUrlRaw) ? piUrlRaw.trim() : "";

    const bentNo = bentNoRaw ? Number(bentNoRaw) : null;

    const id = safeIdFromRow({ instrumentName, bentNo, bentLetter, sensorClass }, idx);
    const blurb = dataCollected ? dataCollected : "";

    return {
      id,
      instrumentName,
      blurb,
      sensorClass,
      wetDry,
      status,
      bentNo,
      bentLetter,
      mllw,
      image,
      urlData,
      owner: { piName, phone, email, piUrl },
    };
  }

  /* ============================================================
     NEW: Dot field based on filtered set
     ============================================================ */
  function uniqueBentDots(list){
    const seen = new Set();
    const pts = [];

    for (const d of list){
      if (!d.bentNo || !d.bentLetter) continue;
      const key = `${d.bentNo}${d.bentLetter}`;
      if (seen.has(key)) continue;
      seen.add(key);

      pts.push({
        key,
        cx: xForBent(d.bentNo),
        cy: yForRow(d.bentLetter),
      });
    }
    return pts;
  }

  function dotsSvg(dots){
    return dots.map(p => `
      <circle
        cx="${p.cx}" cy="${p.cy}" r="1.00"
        fill="rgba(185,189,195,.35)"
        stroke="rgba(255,255,255,.35)"
        stroke-width="0.25"
      />
    `).join("");
  }

  /* ============================================================
     Header map renderer (background SVG + silhouette + dots + callout)
     ============================================================ */
  function headerPierSvg(sel, dots){
    const dotsMarkup = dotsSvg(dots || []);

    // Always render background + pier silhouette + dots
    if(!sel || !sel.bentNo){
      return `
        <svg class="mapSvg" viewBox="0 0 203.2 31.75" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Pier map">
          <image href="${PIER_BG_URL}" x="0" y="0" width="203.2" height="31.75" preserveAspectRatio="none" />
          <path d="${OUTLINE_D}" fill="rgba(185,189,195,.95)" stroke="rgba(255,255,255,.10)" stroke-width="0.25"/>
          <g>${dotsMarkup}</g>
        </svg>
      `;
    }

    const cx = xForBent(sel.bentNo);
    const cy = yForRow(sel.bentLetter);
    const label = `Bent ${sel.bentNo}${sel.bentLetter}`;

    const placeRight = cx < 140;
    const boxW = 58, boxH = 11;

    const lx = Math.max(6, Math.min(placeRight ? cx + 10 : cx - (boxW + 10), 203.2 - (boxW + 6)));
    const ly = Math.max(2, Math.min(cy - 8, 31.75 - (boxH + 2)));

    const ax = placeRight ? (lx + 2) : (lx + boxW - 2);
    const ay = ly + 7;

    return `
      <svg class="mapSvg" viewBox="0 0 203.2 31.75" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Pier map">
        <defs>
          <filter id="glow" x="-40%" y="-40%" width="180%" height="180%">
            <feGaussianBlur in="SourceGraphic" stdDeviation="1.3" result="b"/>
            <feMerge>
              <feMergeNode in="b"/>
              <feMergeNode in="SourceGraphic"/>
            </feMerge>
          </filter>
        </defs>

        <image href="${PIER_BG_URL}" x="0" y="0" width="203.2" height="31.75" preserveAspectRatio="none" />

        <!-- Pier silhouette -->
        <path d="${OUTLINE_D}" fill="rgba(185,189,195,.95)" stroke="rgba(255,255,255,.10)" stroke-width="0.25"/>

        <!-- Filter dots (grey) -->
        <g>${dotsMarkup}</g>

        <!-- Highlight (on top of dots) -->
        <circle cx="${cx}" cy="${cy}" r="4.9" fill="#ffffff" opacity="0.90" filter="url(#glow)"/>
        <circle cx="${cx}" cy="${cy}" r="3.8" fill="none" stroke="rgba(255,255,255,.88)" stroke-width="0.75"/>
        <circle cx="${cx}" cy="${cy}" r="1.7" fill="${getComputedStyle(document.documentElement).getPropertyValue('--accent') || '#00b3c7'}"/>

        <!-- Callout arrow + label box -->
        <path d="M ${cx} ${cy} L ${ax} ${ay}" stroke="rgba(255,255,255,.75)" stroke-width="0.55" fill="none"/>

        <g transform="translate(${lx},${ly})">
          <rect x="0" y="0" rx="2.5" ry="2.5" width="${boxW}" height="${boxH}"
                fill="rgba(255,255,255,.94)" />
          <text x="4" y="8.2"
                font-family="Brix Sans, system-ui"
                font-size="5.6"
                font-weight="700"
                fill="#0b1220">${label}</text>
        </g>
      </svg>
    `;
  }

  /* ============================================================
     Modal (Owner)
     ============================================================ */
  function openOwnerModal(item){
    const pi = item.owner?.piName || "Owner";
    els.mtitle.textContent = pi;
    els.msub.textContent = item.instrumentName ? `Instrument: ${item.instrumentName}` : "—";

    els.mpi.textContent = item.owner?.piName || "—";
    els.memail.innerHTML = item.owner?.email
      ? `<a href="mailto:${item.owner.email}">${item.owner.email}</a>`
      : "—";
    els.mphone.innerHTML = item.owner?.phone
      ? `<a href="tel:${item.owner.phone}">${item.owner.phone}</a>`
      : "—";
    els.murl.innerHTML = item.owner?.piUrl
      ? `<a href="${item.owner.piUrl}" target="_blank" rel="noopener">${item.owner.piUrl}</a>`
      : "—";

    els.backdrop.classList.add("on");
  }
  function closeOwnerModal(){ els.backdrop.classList.remove("on"); }
  els.mclose.addEventListener("click", closeOwnerModal);
  els.backdrop.addEventListener("click", (e)=>{ if(e.target===els.backdrop) closeOwnerModal(); });
  document.addEventListener("keydown", (e)=>{ if(e.key==="Escape") closeOwnerModal(); });

  /* ============================================================
     State + Rendering
     ============================================================ */
  let ALL = [];
  let filtered = [];
  let selectedId = null;

  function unique(arr){ return Array.from(new Set(arr)); }

  function buildFilterOptions(){
    const classes = ["All", ...unique(ALL.map(x=>x.sensorClass).filter(Boolean)).sort((a,b)=>a.localeCompare(b))];
    els.classSel.innerHTML = classes.map(x => `<option value="${x}">${x}</option>`).join("");

    const statuses = ["All", ...unique(ALL.map(x=>x.status).filter(Boolean)).sort((a,b)=>a.localeCompare(b))];
    els.statusSel.innerHTML = statuses.map(x => `<option value="${x}">${x}</option>`).join("");
  }

  function render(){
    const c = els.classSel.value || "All";
    const s = els.statusSel.value || "All";
    const q = (els.q.value || "").trim().toLowerCase();

    filtered = ALL.filter(d => {
      if (c !== "All" && d.sensorClass !== c) return false;
      if (s !== "All" && d.status !== s) return false;
      if (q && !String(d.instrumentName||"").toLowerCase().includes(q)) return false;
      return true;
    });

    const sel = filtered.find(d => d.id === selectedId) || null;

    // NEW: dots based on filtered items
    const dots = uniqueBentDots(filtered);

    els.map.innerHTML = headerPierSvg(sel, dots);
    els.selectedLine.textContent = sel
      ? `${sel.instrumentName} — Bent ${sel.bentNo}${sel.bentLetter}`
      : "Select an instrument to highlight its bent.";

    els.count.textContent = `Showing ${filtered.length}`;

    els.grid.innerHTML = filtered.map(d => {
      const col = statusColor(d.status).trim() || "#8bd17c";
      const loc = d.bentNo ? `Bent ${d.bentNo}${d.bentLetter}` : "Bent —";
      const meta = `${d.sensorClass || "—"} • ${loc}`;

      const ownerLabel = d.owner?.piName ? d.owner.piName : "Owner";
      const dataBtn = d.urlData
        ? `<a class="cta primary" href="${d.urlData}" target="_blank" rel="noopener">Data</a>`
        : ``;

      const img = d.image
        ? `<img src="${d.image}" alt="" loading="lazy" referrerpolicy="no-referrer" crossorigin="anonymous"
                onerror="this.remove()">`
        : ``;

      return `
        <article class="tile ${d.id===selectedId ? "sel":""}" data-id="${d.id}">
          <div class="tileImg">${img}</div>
          <div class="tileBody">
            <div class="rowTop">
              <div>
                <h2 class="tileTitle">${d.instrumentName || "Unnamed"}</h2>
                <div class="tileSub">${d.blurb || ""}</div>
              </div>
              <div class="statusPill" style="color:${col}">
                <span class="dot"></span>${d.status || "Operational"}
              </div>
            </div>

            <div class="tileMeta">${meta}</div>

            <div class="ctaRow">
              ${dataBtn}
              <button class="cta" type="button" data-owner="${d.id}">${ownerLabel}</button>
            </div>
          </div>
        </article>
      `;
    }).join("");

    // click tile to select
    els.grid.querySelectorAll(".tile").forEach(tile => {
      tile.addEventListener("click", (e) => {
        const target = e.target;
        if (target && target.closest && target.closest("button[data-owner]")) return;
        selectedId = tile.dataset.id;
        render();
      });
    });

    // owner buttons
    els.grid.querySelectorAll("button[data-owner]").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-owner");
        const item = ALL.find(x => x.id === id) || filtered.find(x => x.id === id);
        if (item) openOwnerModal(item);
      });
    });
  }

  /* ============================================================
     Init + Load CSV
     ============================================================ */
  async function init(){
    try{
      const params = new URLSearchParams(location.search);
      const csvUrl = getCsvUrlFromParams(params) || DEFAULT_CSV;

      if (!csvUrl) {
        throw new Error("No CSV configured. Add ?csv=... or set DEFAULT_CSV in pier.html.");
      }

      const txt = await fetchText(csvUrl);
      const raw = parseCSV(txt);

      ALL = raw.map(mapRow).filter(x => x.instrumentName || x.sensorClass || x.bentNo);

      buildFilterOptions();

      // wire events
      els.classSel.addEventListener("change", () => { selectedId=null; render(); });
      els.statusSel.addEventListener("change", () => { selectedId=null; render(); });
      els.q.addEventListener("input", () => { selectedId=null; render(); });

      els.clear.addEventListener("click", () => {
        els.classSel.value = "All";
        els.statusSel.value = "All";
        els.q.value = "";
        selectedId = null;
        render();
      });

      render();
    } catch (e){
      console.error(e);
      els.err.style.display = "block";
      els.err.textContent = `Couldn’t load spreadsheet:\n${e.message || e}`;
      els.count.textContent = "Showing 0";
      els.map.innerHTML = headerPierSvg(null, []);
    }
  }

  init();
})();
</script>
</body>
</html>
