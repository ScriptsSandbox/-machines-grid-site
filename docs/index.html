<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Explore Tools</title>
  <style>
    :root{
      --aqua:#00C6D7;     /* brand aqua */
      --green:#6E963B;    /* operational */
      --yellow:#F3E500;   /* hazard/limited accent */
      --orange:#F59E0B;   /* limited status */
      --red:#EF4444;      /* out-of-service */
      --slate:#0F172A;
      --card:#FFFFFF;
      --edge:#E2E8F0;     /* slate-200 */
      --bg:#F1F5F9;       /* slate-100 */
      --text:#0F172A;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    .wrap{max-width:1180px;margin:0 auto;padding:24px 16px 56px}
    .layout{
      display:grid; gap:24px;
      grid-template-columns: 1fr;
    }
    @media (min-width: 1024px){
      .layout{ grid-template-columns: 1fr 320px; align-items:start; }
      .sidebar{ position: sticky; top: 16px }
    }
    .card{
      background:#fff; border:1px solid var(--edge); border-radius:16px; box-shadow:0 8px 14px rgba(0,0,0,.05);
    }
    .pad{ padding:16px }
    .filters h2{ margin:0 0 2px 0; font-size:1.25rem }
    .muted{ color:#64748B }
    .row{ display:flex; gap:8px; align-items:center }
    .chips{ display:flex; flex-wrap:wrap; gap:8px }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      font-size:.75rem; font-weight:600; line-height:1;
      padding:6px 10px; border-radius:9999px; user-select:none; cursor:default;
      border:1px solid rgba(0,0,0,.08);
    }
    .chip.btn{ cursor:pointer }
    .chip[data-selected="1"]{ outline:2px solid var(--aqua); outline-offset:1px }
    .chip .dot{
      width:10px; height:10px; border-radius:50%;
      background: currentColor;
      box-shadow:
        0 0 0 4px rgba(0,0,0,0),         /* will be overridden inline */
        0 0 10px 2px rgba(0,0,0,0);      /* overridden inline */
      filter:saturate(1.2);
    }
    /* Cards grid */
    .grid{ display:grid; gap:16px; grid-template-columns: 1fr; }
    @media (min-width: 640px){ .grid{ grid-template-columns: repeat(2, 1fr); } }
    @media (min-width: 1200px){ .grid{ grid-template-columns: repeat(3, 1fr); } }
    .tool{ display:flex; flex-direction:column; gap:8px; transition: box-shadow .2s ease }
    .tool:hover{ box-shadow:0 12px 18px rgba(0,0,0,.07) }
    .imgwrap{ overflow:hidden; border-radius:12px; height:160px; background:#e5e7eb }
    .imgwrap img{ width:100%; height:100%; object-fit:cover; display:block }
    .tool h3{ font-size:1rem; margin:2px 0 0 0 }
    .tool .meta{ font-size:.8rem; color:#64748B }
    .kvs{ display:grid; gap:6px; margin-top:6px; font-size:.9rem }
    .kv{ display:flex; gap:10px; align-items:flex-start }
    .kv .k{ min-width:120px; color:#64748B; flex-shrink:0 }
    .count{ margin:8px 0 0 0; font-size:.9rem }
    .divider{ height:1px; background:var(--edge); margin:8px 0 }
    .footer-note{ font-size:.85rem; color:#64748B }
    a.cardlink{ color:inherit; text-decoration:none }
    .legend li{ display:flex; gap:8px; align-items:center; }
  </style>
</head>
<body>
  <div class="wrap">
    <main class="layout">
      <!-- LEFT: Filters + Grid + Info -->
      <section class="maincol">

        <!-- Filters -->
        <div class="card pad filters">
          <div class="row" style="justify-content:space-between; align-items:flex-start">
            <div>
              <h2>Explore Tools</h2>
              <div id="count" class="count muted">Loading…</div>
            </div>
            <div>
              <button id="clearBtn" class="chip btn" style="background:#fff">Clear</button>
            </div>
          </div>

          <div style="margin-top:10px; font-size:.8rem; color:#475569">Categories</div>
          <div id="catChips" class="chips" style="margin-top:6px"></div>

          <div style="margin-top:10px; font-size:.8rem; color:#475569">Status</div>
          <div id="statChips" class="chips" style="margin-top:6px"></div>
        </div>

        <!-- Grid -->
        <div id="grid" class="grid" aria-live="polite"></div>

        <!-- Info blocks -->
        <div class="card pad" style="margin-top:16px">
          <h3 style="margin:0 0 6px 0; font-size:1rem">Materials: quick notes</h3>
          <ul style="margin:6px 0 0 16px; padding:0; color:#334155; font-size:.95rem">
            <li><b>Laser:</b> Acrylic, plywood, paper/card are OK. <b>No PVC, vinyl, polycarbonate.</b></li>
            <li><b>3D Print:</b> Sandbox policy is <b>PLA only</b>.</li>
            <li><b>Machining:</b> Aluminum & plastics common; check in on steels. Bring material info.</li>
          </ul>
        </div>

        <div class="card pad" style="margin-top:16px">
          <h3 style="margin:0 0 6px 0; font-size:1rem">Prep your files</h3>
          <ul style="margin:6px 0 0 16px; padding:0; color:#334155; font-size:.95rem">
            <li><b>Laser:</b> Vector (SVG, DXF) for cuts; high-contrast raster for engraves.</li>
            <li><b>3D Print:</b> Export <b>STL/3MF</b>; check manifold/watertight; layer height 0.2 mm typical.</li>
            <li><b>CNC:</b> Provide STEP + drawing; staff review setups & tooling.</li>
          </ul>
        </div>

      </section>

      <!-- RIGHT: Sidebar -->
      <aside class="sidebar">
        <div class="card pad">
          <h4 style="margin:0; font-size:.95rem">Legend</h4>
          <ul class="legend" style="list-style:none; padding:0; margin:12px 0 0 0; color:#334155; font-size:.95rem">
            <li><span class="chip" style="color:var(--green); background:rgba(110,150,59,.12); border-color:rgba(110,150,59,.25)">
              <span class="dot" style="color:var(--green); box-shadow:0 0 0 4px rgba(110,150,59,.35), 0 0 10px 2px rgba(110,150,59,.35)"></span>
              Operational</span> <span>Available for general use</span></li>
            <li><span class="chip" style="color:var(--orange); background:rgba(245,158,11,.12); border-color:rgba(245,158,11,.25)">Limited</span> <span>Staff-assisted / capacity-limited</span></li>
            <li><span class="chip" style="color:var(--red); background:rgba(239,68,68,.12); border-color:rgba(239,68,68,.25)">Out of Service</span> <span>Temporarily unavailable</span></li>
            <li><span class="chip" style="color:var(--yellow); background:rgba(243,229,0,.12); border-color:rgba(243,229,0,.25)">Hazard Class 1</span> <span>Extra safety considerations</span></li>
          </ul>
        </div>

        <div class="card pad" style="margin-top:16px">
          <h4 style="margin:0; font-size:.95rem">Materials & Safety</h4>
          <ul style="margin:10px 0 0 16px; padding:0; color:#334155; font-size:.95rem">
            <li>Laser: <b>NO PVC/vinyl/polycarbonate</b>. Ask if unsure.</li>
            <li>3D Printing: <b>PLA only</b> at Sandbox.</li>
            <li>Machining: Deburr & clean after use.</li>
            <li>Report issues to staff; we’ll tag and service tools.</li>
            <li>No solo operation of power tools.</li>
          </ul>
        </div>
      </aside>
    </main>

    <footer class="footer-note" style="margin-top:20px">
      © <span id="year"></span> SIO • Sandbox Makerspace • Built for clarity and quick access
    </footer>
  </div>

<script>
(function(){
  // --- Brand + meta
  const BRAND = {
    aqua: "#00C6D7", green:"#6E963B", yellow:"#F3E500", orange:"#F59E0B", red:"#EF4444"
  };
  const STATUS_META = {
    operational: { label: "Operational", color: BRAND.green },
    limited:     { label: "Limited",     color: BRAND.orange },
    out:         { label: "Out of Service", color: BRAND.red },
    setup:       { label: "In Setup",    color: BRAND.aqua }
  };
  const HAZARD_META = {
    "HC-0": { label: "Hazard Class 0", color: "rgba(148,163,184,.8)" }, // slate-400ish
    "HC-1": { label: "Hazard Class 1", color: BRAND.yellow },
    "HC-2": { label: "Hazard Class 2", color: BRAND.orange },
    "HC-3": { label: "Hazard Class 3", color: BRAND.red }
  };

  // --- DOM
  const els = {
    count: document.getElementById('count'),
    grid: document.getElementById('grid'),
    catChips: document.getElementById('catChips'),
    statChips: document.getElementById('statChips'),
    clearBtn: document.getElementById('clearBtn')
  };

  document.getElementById('year').textContent = new Date().getFullYear();

  // --- Utils
  function esc(s){ return (s==null?'':String(s)).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
  function hexToRgb(hex){
    const h = hex.replace('#',''); const n = parseInt(h,16);
    return {r:(n>>16)&255, g:(n>>8)&255, b:n&255};
  }
  function withAlpha(hex,a){ const {r,g,b}=hexToRgb(hex); return `rgba(${r},${g},${b},${a})`; }
  function uniq(arr){ return [...new Set(arr)]; }
  function sortStr(a,b){ return String(a).localeCompare(String(b)); }

  // --- Status/Hazard normalization
  function normStatus(s){
    const v = String(s||'').trim().toLowerCase();
    if (/(down|offline|out\s*of\s*service)/.test(v)) return 'out';
    if (/(restricted|limited)/.test(v)) return 'limited';
    if (/(setup|in setup|commission)/.test(v)) return 'setup';
    return 'operational';
  }
  function normHazard(h){
    const v = String(h||'').trim();
    if (!v) return 'HC-0';
    const key = (v.toUpperCase().startsWith('HC-')? v.toUpperCase() : 'HC-' + v);
    return HAZARD_META[key] ? key : 'HC-0';
  }

  // --- Spec parsing (first 3 key:value lines shown)
  function parseSpecsCell(specs){
    const out = [];
    const lines = String(specs||'').replace(/\r/g,'').split('\n').map(x=>x.trim()).filter(Boolean);
    for (const line of lines){
      const m = line.match(/^([^:]+):\s*(.*)$/);
      if (m) out.push([m[1].trim(), m[2].trim()]);
      else out.push(['Notes', line]);
    }
    return out;
  }

  // --- CSV / GVIZ loaders
  function normalizeKey(k){ return String(k||'').trim().toLowerCase().replace(/\s+/g,'_'); }
  function parseCSV(text){
    const rows=[]; let i=0, field='', row=[], inQ=false;
    function pushF(){ row.push(field); field=''; }
    function pushR(){ rows.push(row); row=[]; }
    while(i<text.length){
      const ch=text[i++]; if(inQ){ if(ch=='"'){ if(text[i]=='"'){field+='"'; i++;} else inQ=false; } else field+=ch; }
      else { if(ch=='"') inQ=true; else if(ch==',') pushF(); else if(ch=='\r'){} else if(ch=='\n'){ pushF(); pushR(); } else field+=ch; }
    }
    pushF(); if(row.length) pushR();
    if(rows.length<2) return [];
    const headers = rows[0].map(normalizeKey);
    const out=[];
    for(let r=1;r<rows.length;r++){
      const line=rows[r]; if(!line.some(v=>v && String(v).trim()!=='')) continue;
      const obj={}; headers.forEach((k,idx)=> obj[k]=(line[idx]||'').toString());
      out.push(obj);
    }
    return out;
  }
  function parseGviz(txt){
    const json = JSON.parse(txt.replace(/^[^{]+/,'').replace(/;?\s*$/,''));
    const cols = (json.table.cols||[]).map(c=>normalizeKey(c.label));
    const rows = json.table.rows || [];
    const out=[];
    for(const r of rows){
      const cells = r.c || []; const obj={};
      cols.forEach((key,i)=> obj[key] = cells[i] ? (cells[i].v != null ? String(cells[i].v) : '') : '');
      out.push(obj);
    }
    return out;
  }
  async function fetchText(url){
    const u = new URL(url, location.href); u.searchParams.set('cb', Date.now());
    const res = await fetch(u.toString(), {cache:'no-cache'}); if(!res.ok) throw new Error(res.status);
    return res.text();
  }

  function mapRow(obj){
    const name = obj.name || obj['Name'] || '';
    const category = obj.category || obj['Category'] || '';
    const location = obj.location || obj['Location'] || '';
    const status = normStatus(obj.status || obj['Status'] || 'operational');
    const hazard = normHazard(obj.hazard_class || obj['Hazard Class'] || '0');
    const usage = obj.access || obj['Access'] || '';
    const image = obj.thumbnail_url || obj['Thumbnail URL'] || '';
    const detail = obj.detail_url || obj['Detail URL'] || '';
    const specs = parseSpecsCell(obj.specs || obj['Specs'] || '');
    return { name, category, location, status, hazard, usage, image, detail, specs };
  }

  // --- State
  let ALL_TOOLS = [];
  let categorySel = 'All';
  const statusSel = new Set(); // 'operational' | 'limited' | 'out' | 'setup'

  // --- Rendering
  function chipHTML({label, color, glow, selected, button}){
    const bg = withAlpha(color, 0.12), bd = withAlpha(color, 0.25);
    const selAttr = selected ? ' data-selected="1"' : '';
    const cls = 'chip' + (button? ' btn':'');
    const dot = glow ? `<span class="dot" style="color:${esc(color)}; box-shadow:0 0 0 4px ${withAlpha(color,.35)}, 0 0 10px 2px ${withAlpha(color,.35)}"></span>` : '';
    return `<span class="${cls}"${selAttr} style="color:${esc(color)}; background:${bg}; border-color:${bd}">${dot}${esc(label)}</span>`;
  }

  function renderFilters(){
    // Categories
    const cats = uniq(ALL_TOOLS.map(t=>t.category).filter(Boolean)).sort(sortStr);
    const catEls = ['All', ...cats].map(c => {
      const html = chipHTML({label:c, color:BRAND.aqua, glow:false, selected:(categorySel===c), button:true});
      return `<button type="button" class="cat" data-cat="${esc(c)}" style="all:unset">${html}</button>`;
    }).join('');
    els.catChips.innerHTML = catEls;

    // Status chips
    const statuses = ['operational','limited','out','setup'];
    const statEls = statuses.map(k => {
      const meta = STATUS_META[k];
      const html = chipHTML({label:meta.label, color:meta.color, glow:(k==='operational'), selected:statusSel.has(k), button:true});
      return `<button type="button" class="stat" data-stat="${k}" style="all:unset">${html}</button>`;
    }).join('');
    els.statChips.innerHTML = statEls;

    // Handlers
    els.catChips.querySelectorAll('button.cat').forEach(btn => {
      btn.onclick = () => { categorySel = btn.getAttribute('data-cat'); renderAll(); };
    });
    els.statChips.querySelectorAll('button.stat').forEach(btn => {
      btn.onclick = () => {
        const k = btn.getAttribute('data-stat');
        if (statusSel.has(k)) statusSel.delete(k); else statusSel.add(k);
        renderAll();
      };
    });
    els.clearBtn.onclick = () => { categorySel='All'; statusSel.clear(); renderAll(); };
  }

  function renderGrid(list){
    els.count.textContent = `Showing ${list.length} of ${ALL_TOOLS.length}`;
    if (!list.length){
      els.grid.innerHTML = `<div class="card pad muted" style="text-align:center">No tools match your filters.</div>`;
      return;
    }
    const cards = list.map(t => {
      const stat = STATUS_META[t.status] || STATUS_META.operational;
      const haz = HAZARD_META[t.hazard];

      const img = t.image ? `<div class="imgwrap"><img src="${esc(t.image)}" alt="${esc(t.name)} photo" loading="lazy"></div>` : `<div class="imgwrap"></div>`;

      const statusChip = chipHTML({label:stat.label, color:stat.color, glow:true});
      const hazardChip = haz ? chipHTML({label:haz.label, color:haz.color, glow:false}) : '';
      const usageChip = t.usage ? chipHTML({label:t.usage, color:BRAND.aqua, glow:false}) : '';

      // Show up to 3 specs
      const specRows = (t.specs||[]).slice(0,3).map(([k,v]) =>
        `<div class="kv"><span class="k">${esc(k)}:</span><span class="v">${esc(v)}</span></div>`
      ).join('');

      const inner = `
        <article class="tool card pad" aria-label="${esc(t.name)}">
          ${img}
          <div class="row" style="justify-content:space-between; align-items:flex-start; gap:12px">
            <div style="min-width:0">
              <div class="meta">${esc(t.category||'')}</div>
              <h3 class="line-clamp-1">${esc(t.name)}</h3>
              <div class="meta">${esc(t.location||'')}</div>
            </div>
            <div style="display:flex; flex-direction:column; gap:6px; align-items:flex-end">
              ${statusChip}
              ${hazardChip}
            </div>
          </div>
          ${specRows ? `<div class="kvs">${specRows}</div>` : ''}
          <div class="chips" style="margin-top:8px">${usageChip}</div>
        </article>`;

      // If Detail URL exists, make the whole card clickable
      if (t.detail){
        return `<a class="cardlink" href="${esc(t.detail)}" target="_blank" rel="noopener">${inner}</a>`;
      }
      return inner;
    }).join('');

    els.grid.innerHTML = cards;
  }

  function renderAll(){
    const list = ALL_TOOLS.filter(t => {
      if (categorySel !== 'All' && t.category !== categorySel) return false;
      if (statusSel.size && !statusSel.has(t.status)) return false;
      return true;
    });
    renderFilters();
    renderGrid(list);
  }

  // --- Load data from ?csv= or ?sheet=&gid=
  (async function load(){
    try{
      const params = new URLSearchParams(location.search);
      const csv = params.get('csv');
      const sheet = params.get('sheet');
      const gid = params.get('gid');
      const sheetName = params.get('sheetName');

      let rows = [];
      if (csv){
        rows = parseCSV(await fetchText(csv));
      } else if (sheet && (gid || sheetName)){
        let url = `https://docs.google.com/spreadsheets/d/${encodeURIComponent(sheet)}/gviz/tq?tqx=out:json`;
        if (gid) url += `&gid=${encodeURIComponent(gid)}`;
        if (sheetName) url += `&sheet=${encodeURIComponent(sheetName)}`;
        rows = parseGviz(await fetchText(url));
      } else {
        els.grid.innerHTML = `<div class="card pad muted" style="text-align:center">Pass <code>?sheet=…&gid=…</code> or <code>?csv=…</code> in the URL.</div>`;
        els.count.textContent = `Showing 0 of 0`;
        return;
      }

      ALL_TOOLS = rows.map(mapRow);
      renderAll();
    }catch(err){
      console.error(err);
      els.grid.innerHTML = `<div class="card pad" style="color:#B91C1C; border-left:4px solid var(--red)">Failed to load data. Ensure the tab is <b>Published to the web</b> and the URL params are correct.</div>`;
      els.count.textContent = `Showing 0 of 0`;
    }
  })();
})();
</script>
</body>
</html>
