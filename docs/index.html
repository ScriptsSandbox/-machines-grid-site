import React, { useMemo, useState } from "react";

/**
 * Explore Tools — Page Mockup (No emojis, image header, chip-only filters)
 * -----------------------------------------------------------------------
 * • UCSD colors: Aqua #00C6D7, Green #6E963B, Yellow #F3E500.
 * • Card now shows a photo banner at the top (placeholder images for now).
 * • Removed emojis and hashtag tags.
 * • Filters are chip-only: categories + statuses. No search, no dropdowns.
 */

const BRAND = {
  aqua: "#00C6D7",
  green: "#6E963B",
  yellow: "#F3E500",
  orange: "#F59E0B",
  red: "#EF4444",
  slate: "#0F172A",
  card: "#FFFFFF",
};

const STATUS_META = {
  operational: { label: "Operational", color: BRAND.green },
  limited: { label: "Limited", color: BRAND.orange },
  out: { label: "Out of Service", color: BRAND.red },
  setup: { label: "In Setup", color: BRAND.aqua },
};

const HAZARD_META = {
  "HC-1": { label: "Hazard Class 1", color: BRAND.yellow },
  "HC-0": { label: "Hazard Class 0", color: "#CBD5E1" },
};

// --- Helpers ---------------------------------------------------------------
function hexToRgb(hex) {
  const h = hex.replace("#", "");
  const bigint = parseInt(h, 16);
  const r = (bigint >> 16) & 255;
  const g = (bigint >> 8) & 255;
  const b = bigint & 255;
  return { r, g, b };
}
function withAlpha(hex, a) {
  const { r, g, b } = hexToRgb(hex);
  return `rgba(${r}, ${g}, ${b}, ${a})`;
}

// --- Sample Data (edit freely) --------------------------------------------
const TOOLS = [
  {
    id: "laser60",
    name: "Laser Cutter (CO₂ 60W)",
    category: "Laser Cutting",
    location: "H‑Lab Makerspace",
    status: "operational",
    hazard: "HC-1",
    usage: "Drop‑in only",
    image: "https://picsum.photos/seed/laser60/800/450",
    specs: {
      "Max bed size": "24 × 18 in (approx)",
      "Max thickness": "~6 mm typical (material‑dependent)",
      "Materials OK": "Acrylic, plywood, MDF, paper/card, cork",
      "Not allowed": "PVC, vinyl, unknown plastics, polycarbonate",
    },
  },
  {
    id: "bambuP1S",
    name: "Bambu Lab P1S",
    category: "3D Printing",
    location: "H‑Lab Makerspace",
    status: "operational",
    hazard: "HC-0",
    usage: "Drop‑in (queue)",
    image: "https://picsum.photos/seed/bambuP1S/800/450",
    specs: {
      "Build volume": "256 × 256 × 256 mm",
      "Materials OK": "PLA only",
      "Not allowed": "ABS, PETG, Nylon (Sandbox policy)",
    },
  },
  {
    id: "bambuA1",
    name: "Bambu Lab A1",
    category: "3D Printing",
    location: "H‑Lab Makerspace",
    status: "operational",
    hazard: "HC-0",
    usage: "Drop‑in (queue)",
    image: "https://picsum.photos/seed/bambuA1/800/450",
    specs: {
      "Build volume": "220 × 220 × 250 mm",
      "Materials OK": "PLA only",
      "Not allowed": "ABS, PETG, Nylon (Sandbox policy)",
    },
  },
  {
    id: "prusaMini",
    name: "Prusa Mini+",
    category: "3D Printing",
    location: "H‑Lab Makerspace",
    status: "operational",
    hazard: "HC-0",
    usage: "Drop‑in (queue)",
    image: "https://picsum.photos/seed/prusaMini/800/450",
    specs: {
      "Build volume": "180 × 180 × 180 mm",
      "Materials OK": "PLA only",
      "Not allowed": "ABS, PETG, Nylon (Sandbox policy)",
    },
  },
  {
    id: "tormach1100",
    name: "Tormach PCNC1100 (CNC Mill)",
    category: "CNC Milling",
    location: "H‑Lab Makerspace",
    status: "limited",
    hazard: "HC-1",
    usage: "Staff‑supervised",
    image: "https://picsum.photos/seed/tormach1100/800/450",
    specs: {
      "Work envelope": "18 × 9.5 × 16.25 in",
      "Materials OK": "Aluminum, plastics; light steel (case‑by‑case)",
      "Not allowed": "Unknown alloys; bring material card",
    },
  },
  {
    id: "hardingeHLVH",
    name: "Hardinge HLV‑H (Lathe)",
    category: "Manual Machining",
    location: "H‑Lab Makerspace",
    status: "operational",
    hazard: "HC-1",
    usage: "Training + check‑off",
    image: "https://picsum.photos/seed/hardinge/800/450",
    specs: {
      "Swing × between centers": "11 in × 18 in (approx)",
      "Materials OK": "Aluminum, brass, plastics",
      "Not allowed": "Magnesium, unknown alloys",
    },
  },
  {
    id: "kentMill",
    name: "Kent Knee Mill (MillPWR)",
    category: "Manual Machining",
    location: "H‑Lab Makerspace",
    status: "operational",
    hazard: "HC-1",
    usage: "Training + check‑off",
    image: "https://picsum.photos/seed/kent/800/450",
    specs: {
      "Table": "~9 × 42 in",
      "Materials OK": "Aluminum, plastics; light steel",
      "Not allowed": "Magnesium, unknown alloys",
    },
  },
  {
    id: "taigMill",
    name: "Taig Micro Mill",
    category: "Precision/Small‑format",
    location: "H‑Lab Makerspace",
    status: "operational",
    hazard: "HC-1",
    usage: "Training + check‑off",
    image: "https://picsum.photos/seed/taigmill/800/450",
    specs: {
      "Use case": "Small plastics & soft metals",
      "Notes": "Great for fixtures, test parts",
    },
  },
  {
    id: "taigLathe",
    name: "Taig Micro Lathe",
    category: "Precision/Small‑format",
    location: "H‑Lab Makerspace",
    status: "operational",
    hazard: "HC-1",
    usage: "Training + check‑off",
    image: "https://picsum.photos/seed/taiglathe/800/450",
    specs: {
      "Use case": "Small plastics & soft metals",
      "Notes": "Pins, spacers, fittings",
    },
  },
  {
    id: "wazer",
    name: "WAZER Desktop Waterjet",
    category: "Abrasive Waterjet",
    location: "H‑Lab Makerspace",
    status: "setup",
    hazard: "HC-1",
    usage: "Staff‑run (pilot)",
    image: "https://picsum.photos/seed/wazer/800/450",
    specs: {
      "Bed": "305 × 460 mm (~12 × 18 in)",
      "Materials OK": "Metals, glass, stone, composites",
      "Notes": "Abrasive handling required",
    },
  },
  {
    id: "vinyl",
    name: "Vinyl Cutter",
    category: "2D Cutting",
    location: "H‑Lab Makerspace",
    status: "operational",
    hazard: "HC-0",
    usage: "Drop‑in",
    image: "https://picsum.photos/seed/vinyl/800/450",
    specs: {
      "Max width": "~24 in",
      "Materials OK": "Standard sign vinyl, stencil film",
      "Not allowed": "PVC for laser — use this tool instead",
    },
  },
  {
    id: "electronics",
    name: "Electronics Benches (Soldering)",
    category: "Electronics",
    location: "H‑Lab Makerspace",
    status: "operational",
    hazard: "HC-0",
    usage: "Drop‑in w/ guidance",
    image: "https://picsum.photos/seed/electronics/800/450",
    specs: {
      "Includes": "Soldering stations, PSUs, scopes, hand tools",
      "Notes": "Ask staff about ESD & fume safety",
    },
  },
  {
    id: "sewing",
    name: "Sewing Machine",
    category: "Textiles",
    location: "H‑Lab Makerspace",
    status: "operational",
    hazard: "HC-0",
    usage: "Drop‑in",
    image: "https://picsum.photos/seed/sewing/800/450",
    specs: {
      "Use case": "Bags, soft mounts, prototyping",
      "Notes": "Bring fabric; ask about needles & thread",
    },
  },
];

const CATEGORIES = [
  "All",
  ...Array.from(new Set(TOOLS.map((t) => t.category))).sort(),
];
const STATUS_KEYS = ["operational", "limited", "out", "setup"];

// --- UI Atoms --------------------------------------------------------------
function Chip({ label, colorHex, glow = false, className = "" }) {
  return (
    <span
      className={`inline-flex items-center gap-1 rounded-full px-2 py-1 text-xs font-medium ${className}`}
      style={{
        backgroundColor: withAlpha(colorHex, 0.12),
        color: colorHex,
        border: `1px solid ${withAlpha(colorHex, 0.25)}`,
      }}
    >
      {glow && <GlowDot colorHex={colorHex} />}
      {label}
    </span>
  );
}

function GlowDot({ colorHex }) {
  const ring = withAlpha(colorHex, 0.35);
  return (
    <span
      className="inline-block h-2.5 w-2.5 rounded-full"
      style={{
        backgroundColor: colorHex,
        boxShadow: `0 0 0 4px ${ring}, 0 0 10px 2px ${ring}`,
        filter: "saturate(1.2)",
      }}
    />
  );
}

// --- Card -----------------------------------------------------------------
function ToolCard({ tool }) {
  const status = STATUS_META[tool.status];
  const hazard = HAZARD_META[tool.hazard] || null;

  return (
    <div className="group relative flex flex-col rounded-2xl border border-slate-200 bg-white p-4 shadow-sm transition hover:shadow-md">
      {/* Image header */}
      {tool.image && (
        <div className="mb-3 overflow-hidden rounded-xl">
          <img
            src={tool.image}
            alt={`${tool.name} in use`}
            className="h-40 w-full object-cover"
            loading="lazy"
          />
        </div>
      )}

      <div className="mb-2 flex items-start justify-between gap-3">
        <div className="min-w-0">
          <div className="text-xs text-slate-500">{tool.category}</div>
          <h3 className="mt-1 line-clamp-1 text-base font-semibold text-slate-900">{tool.name}</h3>
          <p className="text-xs text-slate-500">{tool.location}</p>
        </div>
        <div className="flex flex-col items-end gap-1">
          <Chip label={status.label} colorHex={status.color} glow />
          {hazard && <Chip label={hazard.label} colorHex={hazard.color} />}
        </div>
      </div>

      <div className="mt-2 grid gap-1 text-sm text-slate-700">
        {Object.entries(tool.specs || {}).slice(0, 3).map(([k, v]) => (
          <div key={k} className="flex items-start gap-2">
            <span className="min-w-28 shrink-0 text-slate-500">{k}:</span>
            <span className="flex-1">{v}</span>
          </div>
        ))}
      </div>

      <div className="mt-3 flex flex-wrap items-center gap-2">
        {tool.usage && (
          <Chip label={tool.usage} colorHex={BRAND.aqua} className="capitalize" />
        )}
      </div>

      {/* Hover affordance */}
      <div className="pointer-events-none absolute inset-x-0 bottom-0 h-0.5 scale-x-0 bg-[var(--aqua)] opacity-0 transition group-hover:scale-x-100 group-hover:opacity-100" />
      <style>{`:root{--aqua:${BRAND.aqua};}`}</style>
    </div>
  );
}

// --- Sidebar ---------------------------------------------------------------
function Sidebar() {
  return (
    <aside className="sticky top-4 hidden h-fit space-y-4 lg:block">
      {/* Legend */}
      <div className="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
        <h4 className="text-sm font-semibold text-slate-900">Legend</h4>
        <div className="mt-3 space-y-2 text-sm">
          <div className="flex items-center gap-2">
            <Chip label="Operational" colorHex={BRAND.green} glow />
            <span className="text-slate-600">Available for general use</span>
          </div>
          <div className="flex items-center gap-2">
            <Chip label="Limited" colorHex={BRAND.orange} />
            <span className="text-slate-600">Staff‑assisted / capacity‑limited</span>
          </div>
          <div className="flex items-center gap-2">
            <Chip label="Out of Service" colorHex={BRAND.red} />
            <span className="text-slate-600">Temporarily unavailable</span>
          </div>
          <div className="flex items-center gap-2">
            <Chip label="Hazard Class 1" colorHex={BRAND.yellow} />
            <span className="text-slate-600">Extra safety considerations</span>
          </div>
        </div>
      </div>

      {/* Quick Links */}
      <div className="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
        <h4 className="text-sm font-semibold text-slate-900">Quick Links</h4>
        <ul className="mt-3 space-y-2 text-sm">
          <li>
            <a className="text-[color:var(--aqua)] hover:underline" href="#">
              Training & Policies
            </a>
          </li>
          <li>
            <a className="text-[color:var(--aqua)] hover:underline" href="#">
              Materials Guide (what’s OK / not OK)
            </a>
          </li>
          <li>
            <a className="text-[color:var(--aqua)] hover:underline" href="#">
              File Prep Quick‑Guides (Laser, 3D Print)
            </a>
          </li>
          <li>
            <a className="text-[color:var(--aqua)] hover:underline" href="#">
              Hours & Access
            </a>
          </li>
        </ul>
      </div>

      {/* Materials & Safety */}
      <div className="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
        <h4 className="text-sm font-semibold text-slate-900">Materials & Safety</h4>
        <ul className="mt-2 list-disc space-y-1 pl-5 text-sm text-slate-700">
          <li>Laser: <b>NO PVC/vinyl/polycarbonate</b>. Ask if unsure.</li>
          <li>3D Printing: <b>PLA only</b> at Sandbox.</li>
          <li>Machining: Deburr & clean machines after use.</li>
          <li>Report issues to staff; we’ll tag and service tools.</li>
          <li>No solo operation of power tools.</li>
        </ul>
      </div>
    </aside>
  );
}

// --- Filters (chip-only) ---------------------------------------------------
function Filters({ category, setCategory, statusSet, toggleStatus, clearAll, totalShowing, totalAll }) {
  return (
    <div className="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
      <div className="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
        <div className="flex-1">
          <h2 className="text-xl font-semibold text-slate-900">Explore Tools</h2>
          <p className="mt-0.5 text-sm text-slate-600">Showing <b>{totalShowing}</b> of {totalAll}</p>
        </div>
        <div className="flex w-full flex-col gap-2 md:w-auto md:flex-row md:items-center">
          <button onClick={clearAll} className="rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm text-slate-700 hover:bg-slate-50">Clear</button>
        </div>
      </div>

      {/* Category chips */}
      <div className="mt-3 flex flex-wrap items-center gap-2">
        {CATEGORIES.map((c) => (
          <button key={c} onClick={() => setCategory(c)}>
            <Chip
              label={c}
              colorHex={BRAND.aqua}
              className={category === c ? "ring-2 ring-offset-1" : ""}
            />
          </button>
        ))}
      </div>

      {/* Status chips */}
      <div className="mt-2 flex flex-wrap items-center gap-2">
        {STATUS_KEYS.map((k) => (
          <button key={k} onClick={() => toggleStatus(k)}>
            <Chip
              label={STATUS_META[k].label}
              colorHex={STATUS_META[k].color}
              glow={k === "operational"}
              className={statusSet.has(k) ? "ring-2 ring-offset-1" : ""}
            />
          </button>
        ))}
      </div>
    </div>
  );
}

// --- Main Page -------------------------------------------------------------
export default function ExploreToolsPage() {
  const [category, setCategory] = useState("All");
  const [statusSet, setStatusSet] = useState(new Set());

  const filtered = useMemo(() => {
    return TOOLS.filter((t) => {
      if (category !== "All" && t.category !== category) return false;
      if (statusSet.size && !statusSet.has(t.status)) return false;
      return true;
    });
  }, [category, statusSet]);

  function toggleStatus(k) {
    const next = new Set(statusSet);
    if (next.has(k)) next.delete(k);
    else next.add(k);
    setStatusSet(next);
  }
  function clearAll() {
    setCategory("All");
    setStatusSet(new Set());
  }

  return (
    <div className="min-h-screen bg-slate-100">
      {/* Page header / mast */}
      <header className="border-b border-slate-200 bg-white/80 backdrop-blur">
        <div className="mx-auto max-w-7xl px-4 py-6">
          <div className="flex items-center justify-between">
            <div>
              <h1 className="text-2xl font-semibold text-slate-900">Explore Tools</h1>
              <p className="mt-1 max-w-2xl text-sm text-slate-600">
                Find the right tool quickly. Filter by category and status. No search, no dropdowns — just clear chips.
              </p>
            </div>
            <a
              href="#materials"
              className="hidden rounded-xl border border-slate-200 px-3 py-2 text-sm text-[color:var(--aqua)] hover:bg-slate-50 md:block"
            >
              Materials & Safety
            </a>
          </div>
          <style>{`:root{--aqua:${BRAND.aqua};}`}</style>
        </div>
      </header>

      {/* Content */}
      <main className="mx-auto max-w-7xl px-4 py-6">
        <div className="grid grid-cols-1 gap-6 lg:grid-cols-[1fr_320px]">
          <section className="space-y-4">
            <Filters
              category={category}
              setCategory={setCategory}
              statusSet={statusSet}
              toggleStatus={toggleStatus}
              clearAll={clearAll}
              totalShowing={filtered.length}
              totalAll={TOOLS.length}
            />

            {/* Grid */}
            <div className="grid grid-cols-1 gap-4 sm:grid-cols-2 xl:grid-cols-3">
              {filtered.map((tool) => (
                <ToolCard key={tool.id} tool={tool} />
              ))}
            </div>

            {/* Info blocks */}
            <section id="materials" className="mt-2 grid gap-4 md:grid-cols-2">
              <div className="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
                <h3 className="text-base font-semibold text-slate-900">Materials: quick notes</h3>
                <ul className="mt-2 list-disc space-y-1 pl-5 text-sm text-slate-700">
                  <li><b>Laser:</b> Acrylic, plywood, paper/card are OK. <b>No PVC, vinyl, polycarbonate.</b></li>
                  <li><b>3D Print:</b> Sandbox policy is <b>PLA only</b>.</li>
                  <li><b>Machining:</b> Aluminum & plastics common; check in on steels. Bring material info.</li>
                </ul>
              </div>
              <div className="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
                <h3 className="text-base font-semibold text-slate-900">Prep your files</h3>
                <ul className="mt-2 list-disc space-y-1 pl-5 text-sm text-slate-700">
                  <li><b>Laser:</b> Vector (SVG, DXF) for cuts; high‑contrast raster for engraves.</li>
                  <li><b>3D Print:</b> Export <b>STL/3MF</b>; check manifold/watertight; layer height 0.2 mm typical.</li>
                  <li><b>CNC:</b> Provide STEP + drawing; we’ll review setups & tooling.</li>
                </ul>
              </div>
            </section>

            {/* FAQ / Notes */}
            <section className="grid gap-4 md:grid-cols-2">
              <div className="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
                <h3 className="text-base font-semibold text-slate-900">Using the space</h3>
                <ul className="mt-2 list-disc space-y-1 pl-5 text-sm text-slate-700">
                  <li>Laser & 3D printing are <b>drop‑in</b> (first‑come queue).</li>
                  <li>No solo operation of power tools. Ask staff for check‑offs.</li>
                  <li>Clean as you go; leave tools better than you found them.</li>
                </ul>
              </div>
              <div className="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
                <h3 className="text-base font-semibold text-slate-900">Something broken?</h3>
                <p className="mt-2 text-sm text-slate-700">
                  Tell staff right away. We’ll tag the tool, update its status on this page, and schedule service. Thanks for helping keep the shop safe.
                </p>
              </div>
            </section>
          </section>

          <Sidebar />
        </div>
      </main>

      <footer className="mt-8 border-t border-slate-200 bg-white/60">
        <div className="mx-auto max-w-7xl px-4 py-6 text-sm text-slate-500">
          © {new Date().getFullYear()} SIO • Sandbox Makerspace • Built for clarity and quick access
        </div>
      </footer>
    </div>
  );
}
