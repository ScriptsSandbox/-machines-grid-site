<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Machines Grid (Static)</title>
  <style>
    :root{
      --page-grey:#747678;
      --ok:#22C55E;
      --warn:#F59E0B;
      --danger:#EF4444;
      --access:#00C6D7;
      --text:#0f172a;
      --card:#ffffff;
      --card-edge:#e5e7eb;
    }
    html,body{margin:0;padding:0;background:var(--page-grey);color:var(--text);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    .wrap{max-width:1200px;margin:0 auto;padding:16px 16px 48px}
    .toolbar{
      display:grid; gap:12px; grid-template-columns: 1fr repeat(4, minmax(0, 180px));
      background:#ffffffaa; backdrop-filter: blur(6px);
      padding:12px; border-radius:16px; border:1px solid var(--card-edge);
      position: sticky; top: 0; z-index: 10;
    }
    .toolbar input, .toolbar select, .toolbar button{
      width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--card-edge); background:#fff
    }
    .toolbar button{cursor:pointer; border-color: transparent; background:#111827; color:#fff}
    .grid{
      margin-top:16px;
      display:grid; gap:16px;
      grid-template-columns: repeat(auto-fill, minmax(260px,1fr));
    }
    .card{
      display:flex; flex-direction:column; background:var(--card); border:1px solid var(--card-edge);
      border-radius:16px; overflow:hidden;
      box-shadow: 0 10px 14px rgba(0,0,0,.06);
    }
    .thumb{aspect-ratio:16/9; background:#f1f5f9; display:block; width:100%; object-fit:cover}
    .pad{padding:14px}
    .name{font-weight:700; font-size:1.05rem; margin:0 0 6px 0}
    .muted{color:#475569; font-size:.9rem}
    .chips{display:flex; flex-wrap:wrap; gap:6px; margin-top:8px}
    .chip{font-size:.75rem; padding:4px 8px; border-radius:999px; border:1px solid #0000}
    .chip.status{color:#0b0b0b; background:#eefbf1; border-color:#00000010}
    .chip.haz{color:#0b0b0b; background:#fff; border-color:#00000020}
    .chip.access{color:#0b0b0b; background:#ecfeff; border:1px solid #00000010}
    .row{display:flex; gap:8px; align-items:center; margin-top:6px}
    .row strong{font-weight:600}
    .actions{margin-top:auto; display:flex; gap:8px; padding:12px; border-top:1px solid var(--card-edge)}
    .btn{flex:1; text-align:center; text-decoration:none; padding:10px 12px; border-radius:10px; border:1px solid var(--card-edge); background:#fff; color:#111827}
    .btn.primary{background:#111827; color:#fff; border-color:transparent}
    .count{margin:12px 4px; color:#1f2937}
    .bar{height:4px; width:100%}
    .err{background:#fff; border-left:4px solid var(--danger); padding:12px; border-radius:8px; margin-top:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="toolbar">
      <input id="q" type="search" placeholder="Search machines, tags, specs…" />
      <select id="fCategory"><option value="">All categories</option></select>
      <select id="fLocation"><option value="">All locations</option></select>
      <select id="fStatus">
        <option value="">All status</option>
        <option>Operational</option>
        <option>Restricted</option>
        <option>Down</option>
      </select>
      <select id="fHazard">
        <option value="">All hazard</option>
        <option value="1">Hazard 1</option>
        <option value="2">Hazard 2</option>
        <option value="3">Hazard 3</option>
      </select>
      <button id="resetBtn" type="button">Reset</button>
    </div>

    <div class="count" id="count">Loading…</div>
    <div class="grid" id="grid"></div>
    <div id="error" class="err" style="display:none"></div>
  </div>

<script>
/*
Usage (pick one):
- Published Sheet (recommended):
  https://<your-site>/index.html?sheet=YOUR_SHEET_ID&gid=TAB_GID
  (Publish that tab to the web → "Web page".)
- Published CSV:
  https://<your-site>/index.html?csv=FULL_CSV_URL
*/

(function(){
  const els = {
    q: document.getElementById('q'),
    fCategory: document.getElementById('fCategory'),
    fLocation: document.getElementById('fLocation'),
    fStatus: document.getElementById('fStatus'),
    fHazard: document.getElementById('fHazard'),
    resetBtn: document.getElementById('resetBtn'),
    grid: document.getElementById('grid'),
    count: document.getElementById('count'),
    error: document.getElementById('error')
  };

  const params = new URLSearchParams(location.search);
  const csvUrl = params.get('csv');
  const sheetId = params.get('sheet');
  const gid = params.get('gid');
  const sheetName = params.get('sheetName'); // optional alternative to gid

  function gvizUrl() {
    if (sheetId && gid) {
      return 'https://docs.google.com/spreadsheets/d/' + encodeURIComponent(sheetId) + '/gviz/tq?tqx=out:json&gid=' + encodeURIComponent(gid);
    }
    if (sheetId && sheetName) {
      return 'https://docs.google.com/spreadsheets/d/' + encodeURIComponent(sheetId) + '/gviz/tq?tqx=out:json&sheet=' + encodeURIComponent(sheetName);
    }
    return null;
  }

  function showError(msg) {
    els.error.style.display = 'block';
    els.error.textContent = msg;
    els.count.textContent = '0 machines shown';
  }

  // Load data
  (async function load(){
    try {
      let items = [];
      if (csvUrl) {
        const text = await fetch(csvUrl, {cache:'no-cache'}).then(r=>r.text());
        items = parseCSV(text);
      } else {
        const url = gvizUrl();
        if (!url) {
          showError('Missing source. Pass ?sheet=YOUR_SHEET_ID&gid=TAB_GID or ?csv=CSV_URL');
          return;
        }
        const txt = await fetch(url, {cache:'no-cache'}).then(r=>r.text());
        // gviz returns: /*O_o*/ google.visualization.Query.setResponse({...});
        const json = JSON.parse(txt.replace(/^[^{]+/, '').replace(/;?\s*$/, ''));
        items = gvizToItems(json);
      }
      window.MACHINES = items;
      setupFilters(items);
      render(items);
    } catch (err) {
      console.error(err);
      showError('Failed to load data. Make sure the sheet is published to the web and the URL params are correct.');
    }
  })();

  function gvizToItems(resp){
    const cols = resp.table.cols.map(c => normalizeKey(c.label));
    const rows = resp.table.rows || [];
    const out = [];
    for (const r of rows) {
      const cells = r.c || [];
      const obj = {};
      cols.forEach((key, i) => {
        obj[key] = cells[i] ? (cells[i].v != null ? String(cells[i].v) : '') : '';
      });
      normalize(obj);
      out.push(obj);
    }
    return out;
  }

  function parseCSV(text){
    // Tiny CSV parser for simple sheets (commas, quotes)
    const rows = [];
    let i = 0, field = '', row = [], inQuotes = false;
    function pushField(){ row.push(field); field=''; }
    function pushRow(){ rows.push(row); row=[]; }
    while (i < text.length) {
      const ch = text[i++];
      if (inQuotes) {
        if (ch === '"') {
          if (text[i] === '"') { field += '"'; i++; }
          else { inQuotes = false; }
        } else field += ch;
      } else {
        if (ch === '"') inQuotes = true;
        else if (ch === ',') pushField();
        else if (ch === '\r') {}
        else if (ch === '\n') { pushField(); pushRow(); }
        else field += ch;
      }
    }
    pushField(); if (row.length) pushRow();
    if (rows.length < 2) return [];
    const headers = rows[0].map(h => normalizeKey(h));
    const out = [];
    for (let r = 1; r < rows.length; r++) {
      const line = rows[r];
      if (!line.some(v => v && String(v).trim() !== '')) continue;
      const obj = {};
      headers.forEach((k, idx) => obj[k] = (line[idx] || '').toString());
      normalize(obj);
      out.push(obj);
    }
    return out;
  }

  function normalize(obj){
    obj.name          = (obj.name||'').trim();
    obj.category      = (obj.category||'').trim();
    obj.location      = (obj.location||'').trim();
    obj.status        = (obj.status||'').trim();
    obj.hazard_class  = (obj.hazard_class || obj.hazardclass || '').trim();
    obj.access        = (obj.access||'').trim();
    obj.access_chips  = splitList(obj.access_chips || obj.accesschips);
    obj.tags          = splitList(obj.tags);
    obj.thumbnail_url = (obj.thumbnail_url || obj.thumbnailurl || '').trim();
    obj.detail_url    = (obj.detail_url || obj.detailurl || '').trim();
    obj.description   = (obj.description || '').trim();
    obj.specs         = (obj.specs || '').trim();
    obj.status_color  = pickStatusColor(obj.status);
    obj.hazard_color  = pickHazardColor(obj.hazard_class);
  }

  function normalizeKey(k){ return String(k||'').trim().toLowerCase().replace(/\s+/g,'_'); }
  function splitList(val){ return (val ? String(val) : '').split(/[;,]/).map(s=>s.trim()).filter(Boolean); }
  function pickStatusColor(status){
    const s = String(status||'').toLowerCase();
    if (s.includes('down') || s.includes('offline') || s.includes('out of service')) return cssVar('--danger');
    if (s.includes('restricted') || s.includes('limited')) return cssVar('--warn');
    return cssVar('--ok');
  }
  function pickHazardColor(h){
    const v = String(h||'').trim();
    if (v === '3') return cssVar('--danger');
    if (v === '2') return cssVar('--warn');
    if (v === '1') return cssVar('--ok');
    return cssVar('--card-edge');
  }
  function cssVar(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }

  // Filters
  function setupFilters(data){
    fillSelect(els.fCategory, uniqueSorted(data,'category'));
    fillSelect(els.fLocation, uniqueSorted(data,'location'));
    [els.q, els.fCategory, els.fLocation, els.fStatus, els.fHazard].forEach(el => el.addEventListener('input', filterAll));
    els.resetBtn.addEventListener('click', () => {
      els.q.value = ''; els.fCategory.value = ''; els.fLocation.value=''; els.fStatus.value=''; els.fHazard.value='';
      filterAll();
    });
  }
  function uniqueSorted(list, key){
    return [...new Set(list.map(x => (x[key]||'').toString().trim()).filter(Boolean))].sort((a,b)=>a.localeCompare(b));
  }
  function fillSelect(select, values){
    values.forEach(v => {
      const opt = document.createElement('option');
      opt.value = v; opt.textContent = v;
      select.appendChild(opt);
    });
  }

  function filterAll(){
    const q = els.q.value.trim().toLowerCase();
    const cat = els.fCategory.value;
    const loc = els.fLocation.value;
    const stat = els.fStatus.value;
    const haz  = els.fHazard.value;
    const list = (window.MACHINES || []).filter(m => {
      if (cat && m.category !== cat) return false;
      if (loc && m.location !== loc) return false;
      if (stat && String(m.status||'').toLowerCase() !== String(stat).toLowerCase()) return false;
      if (haz && String(m.hazard_class) !== String(haz)) return false;
      if (q) {
        const hay = [m.name, m.category, m.location, m.status, m.description, m.specs, (m.tags||[]).join(' ')].join(' ').toLowerCase();
        if (!hay.includes(q)) return false;
      }
      return true;
    });
    render(list);
  }

<script>
  function esc(s){
    return (s == null ? '' : String(s))
      .replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }
</script>  
  
  function tint(color, alpha){
    const hex = String(color||'').replace('#','');
    if (/^[0-9a-fA-F]{6}$/.test(hex)) {
      const r=parseInt(hex.slice(0,2),16), g=parseInt(hex.slice(2,4),16), b=parseInt(hex.slice(4,6),16);
      return 'rgba('+r+','+g+','+b+','+alpha+')';
    }
    return color;
  }

  function render(list){
    els.count.textContent = list.length + ' machine' + (list.length===1?'':'s') + ' shown';
    const html = list.map(m => {
      const chips = [
        '<span class="chip status" style="background:'+tint(m.status_color,0.12)+';border-color:'+tint(m.status_color,0.2)+'">Status: '+esc(m.status||'—')+'</span>',
        (m.hazard_class ? '<span class="chip haz" style="background:'+tint(m.hazard_color,0.10)+';border-color:'+tint(m.hazard_color,0.2)+'">Hazard '+esc(m.hazard_class)+'</span>' : ''),
        ...((m.access_chips||[]).map(c => '<span class="chip access" style="background:'+tint(cssVar('--access'),0.10)+';border-color:'+tint(cssVar('--access'),0.2)+'">'+esc(c)+'</span>'))
      ].join('');
      const thumb = m.thumbnail_url ? '<img class="thumb" alt="" loading="lazy" src="'+esc(m.thumbnail_url)+'">' : '<div class="thumb"></div>';
      const link  = m.detail_url ? '<a class="btn" href="'+esc(m.detail_url)+'" target="_blank" rel="noopener">Details</a>' : '';
      return [
        '<article class="card" aria-label="'+esc(m.name)+'">',
        thumb,
        '<div class="bar" style="background:'+esc(m.status_color)+'"></div>',
        '<div class="pad">',
          '<h3 class="name">'+esc(m.name)+'</h3>',
          '<div class="muted">'+esc(m.category||'')+(m.category&&m.location?' · ':'')+esc(m.location||'')+'</div>',
          '<div class="chips">'+chips+'</div>',
          (m.description ? '<div class="row"><span class="muted">'+esc(m.description)+'</span></div>' : ''),
          (m.specs ? '<div class="row"><strong>Specs:</strong><span class="muted" style="white-space:pre-wrap">'+esc(m.specs)+'</span></div>' : ''),
        '</div>',
        '<div class="actions">',
          link,
          '<a class="btn primary" href="javascript:void(0)" onclick="alert(\'Contact staff to use this tool.\');">Get Access</a>',
        '</div>',
        '</article>'
      ].join('');
    }).join('');
    els.grid.innerHTML = html || '<div class="muted">No machines match your filters.</div>';
    tryPostHeight();
  }

  function tryPostHeight(){
    try{
      const h = document.documentElement.scrollHeight;
      window.parent && window.parent.postMessage({type:'machines-grid-height', height:h}, '*');
    }catch(e){}
  }

  window.addEventListener('resize', tryPostHeight);
})();
</script>
</body>
</html>
