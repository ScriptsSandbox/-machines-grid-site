<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Machines Grid (Static)</title>
  <style>
    :root{
      /* UCSD-ish palette + your background */
      --page-grey:#747678;
      --ok:#6E963B;     /* status: Operational */
      --warn:#F3E500;   /* status: Restricted / Hazard */
      --danger:#EF4444; /* status: Down */
      --access:#00C6D7; /* access chips */
      --text:#0f172a;
      --card:#ffffff;
      --card-edge:#e5e7eb;
    }
    html,body{margin:0;padding:0;background:var(--page-grey);color:var(--text);font:16px/1.45 Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:1200px;margin:0 auto;padding:16px 16px 48px}
    .toolbar{
      display:grid; gap:12px; grid-template-columns: 1fr repeat(4, minmax(0, 180px));
      background:#ffffffaa; backdrop-filter: blur(6px);
      padding:12px; border-radius:16px; border:1px solid var(--card-edge);
      position: sticky; top: 0; z-index: 10;
    }
    .toolbar input, .toolbar select, .toolbar button{
      width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--card-edge); background:#fff
    }
    .toolbar button{cursor:pointer; border-color: transparent; background:#111827; color:#fff}
    .grid{
      margin-top:16px;
      display:grid; gap:16px;
      grid-template-columns: repeat(auto-fill, minmax(260px,1fr));
    }
    .card{
      display:flex; flex-direction:column; background:var(--card); border:1px solid var(--card-edge);
      border-radius:16px; overflow:hidden;
      box-shadow: 0 10px 14px rgba(0,0,0,.06);
    }
    .thumb{aspect-ratio:16/9; background:#f1f5f9; display:block; width:100%; object-fit:cover}
    .pad{padding:14px}
    .name{font-weight:700; font-size:1.05rem; margin:0 0 6px 0}
    .muted{color:#475569; font-size:.9rem}
    .chips{display:flex; flex-direction:column; gap:4px; margin-top:8px}

    /* Base chip */
    .chip{
      font-size:.85rem; display:flex; align-items:center; gap:8px;
      padding:6px 10px; border-radius:9999px; line-height:1;
      border:1px solid var(--card-edge); background:#fff; color:#111827;
      width:max-content;
    }
    /* Filled variant uses --chip-bg (set inline) with a subtle/tinted look */
    .chip.filled{
      border-color: rgba(0,0,0,.06);
      background: rgba(0,0,0,.02);
      color:#111827;
    }

    /* Subtle live glow only for STATUS chip dot */
    .chip.status::before{
      content:"";
      width:8px; height:8px; border-radius:50%;
      background:var(--dot-color,var(--card-edge));
      /* gentle, not flashy */
      filter: drop-shadow(0 0 3px var(--dot-color,var(--card-edge)));
      animation: dotPulse 2.4s ease-in-out infinite;
      opacity:.95;
    }
    @keyframes dotPulse{
      0%,100% { transform: scale(1); }
      50%     { transform: scale(1.18); }
    }
    @media (prefers-reduced-motion: reduce){
      .chip.status::before{ animation:none; filter:none; }
    }

    .row{display:flex; gap:8px; align-items:center; margin-top:6px}
    .row strong{font-weight:600}
    .actions{margin-top:auto; display:flex; gap:8px; padding:12px; border-top:1px solid var(--card-edge)}
    .btn{flex:1; text-align:center; text-decoration:none; padding:10px 12px; border-radius:10px; border:1px solid var(--card-edge); background:#fff; color:#111827}
    .btn.primary{background:#111827; color:#fff; border-color:transparent}
    .count{margin:12px 4px; color:#1f2937}
    .bar{height:4px; width:100%}
    .err{background:#fff; border-left:4px solid var(--danger); padding:12px; border-radius:8px; margin-top:12px}

    /* Hide “Get Access” for now */
    .actions .btn.primary{ display:none !important; }
  </style>

  <!-- Inter font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
  <div class="wrap">
    <div class="toolbar">
      <input id="q" type="search" placeholder="Search machines, tags, specs…" />
      <select id="fCategory"><option value="">All categories</option></select>
      <select id="fLocation"><option value="">All locations</option></select>
      <select id="fStatus">
        <option value="">All status</option>
        <option>Operational</option>
        <option>Restricted</option>
        <option>Down</option>
      </select>
      <select id="fHazard">
        <option value="">All hazard</option>
        <option value="1">Hazard 1</option>
        <option value="2">Hazard 2</option>
        <option value="3">Hazard 3</option>
      </select>
      <button id="resetBtn" type="button">Reset</button>
    </div>

    <div class="count" id="count">Loading…</div>
    <div class="grid" id="grid"></div>
    <div id="error" class="err" style="display:none"></div>
  </div>

<script>
/*
Usage (pick one):
- Published Sheet:
  https://<your-site>/index.html?sheet=YOUR_SHEET_ID&gid=TAB_GID
- Published CSV (2PACX link):
  https://<your-site>/index.html?csv=FULL_CSV_URL (URL-encoded)
*/

(function(){
  const els = {
    q: document.getElementById('q'),
    fCategory: document.getElementById('fCategory'),
    fLocation: document.getElementById('fLocation'),
    fStatus: document.getElementById('fStatus'),
    fHazard: document.getElementById('fHazard'),
    resetBtn: document.getElementById('resetBtn'),
    grid: document.getElementById('grid'),
    count: document.getElementById('count'),
    error: document.getElementById('error')
  };

  const params = new URLSearchParams(location.search);
  const csvUrl = getCsvUrlFromParams(params);      // tolerant csv param
  const sheetId = params.get('sheet');
  const gid = params.get('gid');
  const sheetName = params.get('sheetName'); // optional alternative to gid

  function gvizUrl() {
    if (sheetId && gid) {
      return 'https://docs.google.com/spreadsheets/d/' + encodeURIComponent(sheetId) + '/gviz/tq?tqx=out:json&gid=' + encodeURIComponent(gid);
    }
    if (sheetId && sheetName) {
      return 'https://docs.google.com/spreadsheets/d/' + encodeURIComponent(sheetId) + '/gviz/tq?tqx=out:json&sheet=' + encodeURIComponent(sheetName);
    }
    return null;
  }

  function getCsvUrlFromParams(p){
    let url = p.get('csv');
    if (!url) return null;
    // If someone pasted an unencoded CSV and WP split params, rebuild them.
    if (!url.includes('?')) {
      const extras = [];
      ['gid','single','output'].forEach(k => {
        const v = p.get(k);
        if (v != null) extras.push(k + '=' + encodeURIComponent(v));
      });
      if (extras.length) url += '?' + extras.join('&');
    }
    return url;
  }

  function showError(msg) {
    els.error.style.display = 'block';
    els.error.textContent = msg;
    els.count.textContent = '0 machines shown';
  }

  // Load data
  (async function load(){
    try {
      let items = [];
      if (csvUrl) {
        const text = await fetchText(csvUrl);
        // If CSV has only headers, show nicer message
        const lines = text.replace(/\r/g,'').split('\n').filter(Boolean);
        if (lines.length <= 1) throw new Error('CSV has headers but no data rows — republish the correct tab.');
        items = parseCSV(text).map(normalize);
      } else {
        const url = gvizUrl();
        if (!url) {
          showError('Missing source. Pass ?sheet=YOUR_SHEET_ID&gid=TAB_GID or ?csv=CSV_URL');
          return;
        }
        const txt = await fetchText(url);
        const json = JSON.parse(txt.replace(/^[^{]+/, '').replace(/;?\s*$/, '')); // /*O_o*/ ...;
        items = gvizToItems(json).map(normalize);
      }
      window.MACHINES = items;
      setupFilters(items);
      render(items);
    } catch (err) {
      console.error(err);
      showError('Failed to load data. Ensure the tab is Published to the web and the URL params are correct.');
    }
  })();

  // Safer fetch: only cache-bust http(s); detect HTML accidents
  async function fetchText(url){
    const u = new URL(url, location.href);
    if (u.protocol === 'http:' || u.protocol === 'https:') {
      u.searchParams.set('cb', Date.now());
    }
    const res = await fetch(u.toString(), {cache:'no-cache'});
    if (!res.ok) throw new Error('HTTP '+res.status);
    const txt = await res.text();
    if (/^\s*</.test(txt)) throw new Error('Received HTML instead of CSV/JSON (check sharing/publish)');
    return txt;
  }

  function gvizToItems(resp){
    const cols = resp.table.cols.map(c => normalizeKey(c.label));
    const rows = resp.table.rows || [];
    const out = [];
    for (const r of rows) {
      const cells = r.c || [];
      const obj = {};
      cols.forEach((key, i) => {
        obj[key] = cells[i] ? (cells[i].v != null ? String(cells[i].v) : '') : '';
      });
      out.push(obj);
    }
    return out;
  }

  function parseCSV(text){
    // Tiny CSV parser for simple sheets (commas, quotes)
    const rows = [];
    let i = 0, field = '', row = [], inQuotes = false;
    function pushField(){ row.push(field); field=''; }
    function pushRow(){ rows.push(row); row=[]; }
    while (i < text.length) {
      const ch = text[i++];
      if (inQuotes) {
        if (ch === '"') {
          if (text[i] === '"') { field += '"'; i++; }
          else { inQuotes = false; }
        } else field += ch;
      } else {
        if (ch === '"') inQuotes = true;
        else if (ch === ',') pushField();
        else if (ch === '\r') {}
        else if (ch === '\n') { pushField(); pushRow(); }
        else field += ch;
      }
    }
    pushField(); if (row.length) pushRow();
    if (rows.length < 2) return [];
    const headers = rows[0].map(h => normalizeKey(h));
    const out = [];
    for (let r = 1; r < rows.length; r++) {
      const line = rows[r];
      if (!line.some(v => v && String(v).trim() !== '')) continue;
      const obj = {};
      headers.forEach((k, idx) => obj[k] = (line[idx] || '').toString());
      out.push(obj);
    }
    return out;
  }

  function normalizeKey(k){ return String(k||'').trim().toLowerCase().replace(/\s+/g,'_'); }

  function normalize(obj){
    // Only using fields from the sheet — no extra text injected
    return {
      name          : (obj.name||'').trim(),
      category      : (obj.category||'').trim(),
      location      : (obj.location||'').trim(),
      status        : (obj.status||'').trim(),
      hazard_class  : (obj.hazard_class || obj['hazard_class'] || '').trim(),
      access        : (obj.access||'').trim(),
      access_chips  : splitList(obj.access_chips || obj.accesschips),
      tags          : splitList(obj.tags),
      thumbnail_url : (obj.thumbnail_url || obj.thumbnailurl || '').trim(),
      detail_url    : (obj.detail_url || obj.detailurl || '').trim(),
      description   : (obj.description || '').trim(),
      specs         : (obj.specs || '').trim(),
      status_color  : pickStatusColor(obj.status),
      hazard_color  : pickHazardColor(obj.hazard_class)
    };
  }

  function splitList(val){ return (val ? String(val) : '').split(/[;,]/).map(s=>s.trim()).filter(Boolean); }
  function cssVar(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }

  function pickStatusColor(status){
    const s = String(status||'').toLowerCase();
    if (s.includes('down') || s.includes('offline') || s.includes('out of service')) return cssVar('--danger');
    if (s.includes('restricted') || s.includes('limited')) return cssVar('--warn');
    return cssVar('--ok'); // default Operational
  }
  function pickHazardColor(h){
    const v = String(h||'').trim();
    if (v === '3') return cssVar('--danger');
    if (v === '2') return cssVar('--warn');
    if (v === '1') return cssVar('--ok');
    return cssVar('--card-edge');
  }

  // Filters
  function setupFilters(data){
    fillSelect(els.fCategory, uniqueSorted(data,'category'));
    fillSelect(els.fLocation, uniqueSorted(data,'location'));
    [els.q, els.fCategory, els.fLocation, els.fStatus, els.fHazard].forEach(el => el.addEventListener('input', filterAll));
    els.resetBtn.addEventListener('click', () => {
      els.q.value = ''; els.fCategory.value = ''; els.fLocation.value=''; els.fStatus.value=''; els.fHazard.value='';
      filterAll();
    });
  }
  function uniqueSorted(list, key){
    return [...new Set(list.map(x => (x[key]||'').toString().trim()).filter(Boolean))].sort((a,b)=>a.localeCompare(b));
  }
  function fillSelect(select, values){
    values.forEach(v => {
      const opt = document.createElement('option');
      opt.value = v; opt.textContent = v;
      select.appendChild(opt);
    });
  }

  function filterAll(){
    const q = els.q.value.trim().toLowerCase();
    const cat = els.fCategory.value;
    const loc = els.fLocation.value;
    const stat = els.fStatus.value;
    const haz  = els.fHazard.value;
    const list = (window.MACHINES || []).filter(m => {
      if (cat && m.category !== cat) return false;
      if (loc && m.location !== loc) return false;
      if (stat && String(m.status||'').toLowerCase() !== String(stat).toLowerCase()) return false;
      if (haz && String(m.hazard_class) !== String(haz)) return false;
      if (q) {
        const hay = [m.name, m.category, m.location, m.status, m.description, m.specs, (m.tags||[]).join(' ')].join(' ').toLowerCase();
        if (!hay.includes(q)) return false;
      }
      return true;
    });
    render(list);
  }

  function esc(s){
    return (s == null ? '' : String(s))
      .replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  function render(list){
    els.count.textContent = list.length + ' machine' + (list.length===1?'':'s') + ' shown';
    const html = list.map(m => {
      const chips = [
        // STATUS chip (colored dot only, subtle glow)
        '<div class="chip status" style="--dot-color:'+esc(m.status_color)+'">'+esc(m.status||'—')+'</div>',
        // HAZARD chip (no dot; color tint implied by text only to stick to sheet content)
        (m.hazard_class ? '<div class="chip haz">'+('Hazard Class '+esc(m.hazard_class))+'</div>' : ''),
        // ACCESS chips (plain, from sheet)
        ...((m.access_chips||[]).map(c => '<div class="chip access">'+esc(c)+'</div>'))
      ].join('');
      const thumb = m.thumbnail_url ? '<img class="thumb" alt="" loading="lazy" src="'+esc(m.thumbnail_url)+'">' : '<div class="thumb"></div>';
      const link  = m.detail_url ? '<a class="btn" href="'+esc(m.detail_url)+'" target="_blank" rel="noopener">Details</a>' : '';
      return [
        '<article class="card" aria-label="'+esc(m.name)+'">',
          thumb,
          '<div class="bar" style="background:'+esc(m.status_color)+'"></div>',
          '<div class="pad">',
            '<h3 class="name">'+esc(m.name)+'</h3>',
            '<div class="muted">'+esc(m.category||'')+(m.category&&m.location?' · ':'')+esc(m.location||'')+'</div>',
            '<div class="chips">'+chips+'</div>',
            (m.description ? '<div class="row"><span class="muted">'+esc(m.description)+'</span></div>' : ''),
            (m.specs ? '<div class="row"><strong>Specs:</strong><span class="muted" style="white-space:pre-wrap">'+esc(m.specs)+'</span></div>' : ''),
          '</div>',
          '<div class="actions">',
            link,
            '<a class="btn primary" href="javascript:void(0)">Get Access</a>',
          '</div>',
        '</article>'
      ].join('');
    }).join('');
    els.grid.innerHTML = html || '<div class="muted">No machines match your filters.</div>';
    tryPostHeight();
  }

  function tryPostHeight(){
    try{
      const h = document.documentElement.scrollHeight;
      window.parent && window.parent.postMessage({type:'machines-grid-height', height:h}, '*');
    }catch(e){}
  }

  window.addEventListener('resize', tryPostHeight);
})();
</script>
</body>
</html>
