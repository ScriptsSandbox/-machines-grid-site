<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Explore Tools</title>

  <!-- Inter font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --aqua:#00C6D7;     /* brand aqua */
      --green:#6E963B;    /* operational */
      --yellow:#F3E500;   /* hazard/limited accent */
      --orange:#F59E0B;   /* limited status */
      --red:#EF4444;      /* out-of-service */
      --text:#0F172A;
      --edge:#E2E8F0;     /* slate-200-ish */
    }
    html,body{
      margin:0; padding:0; background:#747678; color:var(--text);
      font:16px/1.45 Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
    }
    .wrap{max-width:1180px;margin:0 auto;padding:24px 16px 56px}

    /* Card + basic UI */
    .card{background:#fff; border:1px solid var(--edge); border-radius:16px; box-shadow:0 8px 14px rgba(0,0,0,.05)}
    .pad{ padding:16px }
    .muted{ color:#64748B }
    .error{ color:#B91C1C }

    /* Filters */
    .filters h2{ margin:0 0 2px 0; font-size:1.5rem; letter-spacing:.2px }
    .row{ display:flex; gap:8px; align-items:center; justify-content:space-between }
    .chips{ display:flex; flex-wrap:wrap; gap:8px }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      font-size:.8rem; font-weight:600; line-height:1;
      padding:8px 12px; border-radius:9999px; user-select:none; cursor:default;
      border:1px solid rgba(0,0,0,.08);
      background:#fff; color:var(--text);
    }
    .chip.btn{ cursor:pointer }
    .chip[data-selected="1"]{ outline:3px solid var(--aqua); outline-offset:1px }

    /* Live status dot + animated glow */
    .chip .dot{
      width:10px; height:10px; border-radius:50%;
      background: currentColor;
      position: relative;
    }
    .chip .dot.live{ animation: dotPulse 1.8s ease-in-out infinite; }
    .chip .dot.live::after{
      content:""; position:absolute; inset:-6px; border-radius:50%;
      background: currentColor; opacity:.35;
      animation: dotRing 1.8s ease-in-out infinite; filter: saturate(1.2);
    }
    @keyframes dotPulse{ 0%,100%{ transform:scale(1) } 50%{ transform:scale(1.25) } }
    @keyframes dotRing { 0%{ transform:scale(.8); opacity:.35 } 70%{ transform:scale(1.6); opacity:0 } 100%{ transform:scale(.8); opacity:0 } }
    @media (prefers-reduced-motion: reduce){
      .chip .dot.live, .chip .dot.live::after{ animation:none }
    }

    /* Tool cards */
    .tool{ display:flex; flex-direction:column; gap:8px; transition: box-shadow .2s ease }
    .tool:hover{ box-shadow:0 12px 18px rgba(0,0,0,.07) }
    .imgwrap{ overflow:hidden; border-radius:12px; height:160px; background:#e5e7eb }
    .imgwrap img{ width:100%; height:100%; object-fit:cover; display:block }
    .tool h3{ font-size:1.05rem; margin:2px 0 0 0 }
    .meta{ font-size:.85rem; color:#64748B }
    .kvs{ display:grid; gap:6px; margin-top:6px; font-size:.95rem }
    .kv{ display:flex; gap:10px; align-items:flex-start }
    .kv .k{ min-width:120px; color:#64748B; flex-shrink:0 }
    a.cardlink{ color:inherit; text-decoration:none }
    .line-clamp-1{ display:-webkit-box; -webkit-line-clamp:1; -webkit-box-orient:vertical; overflow:hidden }

    /* Masonry layout (CSS columns) */
    .masonry{ column-width: 320px; column-gap:16px }
    @media (max-width: 640px){ .masonry{ column-width: 100% } }
    .masonry .item{ break-inside: avoid; margin:0 0 16px }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Filters -->
    <div class="card pad filters">
      <div class="row" style="align-items:flex-start">
        <div>
          <h2>Explore Tools</h2>
          <div id="count" class="muted" style="margin-top:4px; font-size:.95rem">Loading…</div>
        </div>
        <button id="clearBtn" class="chip btn">Clear</button>
      </div>

      <div style="margin-top:10px; font-size:.9rem; color:#475569">Categories</div>
      <div id="catChips" class="chips" style="margin-top:6px"></div>

      <div style="margin-top:10px; font-size:.9rem; color:#475569">Status</div>
      <div id="statChips" class="chips" style="margin-top:6px"></div>
    </div>

    <!-- Masonry grid -->
    <div id="grid" class="masonry" aria-live="polite" style="margin-top:16px"></div>

    <footer style="margin-top:24px; font-size:.9rem; color:#E5E7EB">
      © <span id="year"></span> SIO • Sandbox Makerspace • Built for clarity and quick access
    </footer>
  </div>

<script>
(function(){
  // --- Brand + meta
  const BRAND = {
    aqua: "#00C6D7", green:"#6E963B", yellow:"#F3E500", orange:"#F59E0B", red:"#EF4444"
  };
  const STATUS_META = {
    operational: { label: "Operational", color: BRAND.green },
    limited:     { label: "Limited",     color: BRAND.orange },
    out:         { label: "Out of Service", color: BRAND.red },
    setup:       { label: "In Setup",    color: BRAND.aqua }
  };
  const HAZARD_META = {
    "HC-0": { label: "Hazard Class 0", color: "rgba(148,163,184,.8)" },
    "HC-1": { label: "Hazard Class 1", color: BRAND.yellow },
    "HC-2": { label: "Hazard Class 2", color: BRAND.orange },
    "HC-3": { label: "Hazard Class 3", color: BRAND.red }
  };

  // --- DOM
  const els = {
    year: document.getElementById('year'),
    count: document.getElementById('count'),
    grid: document.getElementById('grid'),
    catChips: document.getElementById('catChips'),
    statChips: document.getElementById('statChips'),
    clearBtn: document.getElementById('clearBtn')
  };
  els.year.textContent = new Date().getFullYear();

  // --- Utils
  function esc(s){ return (s==null?'':String(s)).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
  function hexToRgb(hex){ const h=hex.replace('#',''); const n=parseInt(h,16); return {r:(n>>16)&255,g:(n>>8)&255,b:n&255}; }
  function withAlpha(hex,a){ const {r,g,b}=hexToRgb(hex); return `rgba(${r},${g},${b},${a})`; }
  function uniq(arr){ return [...new Set(arr)]; }
  function sortStr(a,b){ return String(a).localeCompare(String(b)); }

  // Normalize status/hazard from sheet text
  function normStatus(s){
    const v = String(s||'').trim().toLowerCase();
    if (/(down|offline|out\s*of\s*service)/.test(v)) return 'out';
    if (/(restricted|limited)/.test(v)) return 'limited';
    if (/(setup|in setup|commission)/.test(v)) return 'setup';
    return 'operational';
  }
  function normHazard(h){
    const v = String(h||'').trim();
    if (!v) return 'HC-0';
    const key = (v.toUpperCase().startsWith('HC-') ? v.toUpperCase() : 'HC-'+v);
    return HAZARD_META[key] ? key : 'HC-0';
  }

  // Parse "Specs" multiline cell into [key,value] pairs
  function parseSpecsCell(specs){
    const out = [];
    const lines = String(specs||'').replace(/\r/g,'').split('\n').map(x=>x.trim()).filter(Boolean);
    for (const line of lines){
      const m = line.match(/^([^:]+):\s*(.*)$/);
      if (m) out.push([m[1].trim(), m[2].trim()]);
      else out.push(['Notes', line]);
    }
    return out;
  }

  // CSV / gviz helpers
  function normalizeKey(k){ return String(k||'').trim().toLowerCase().replace(/\s+/g,'_'); }

  function parseCSV(text){
    const rows=[]; let i=0, field='', row=[], inQ=false;
    function pushF(){ row.push(field); field=''; }
    function pushR(){ rows.push(row); row=[]; }
    while(i<text.length){
      const ch=text[i++]; if(inQ){ if(ch=='"'){ if(text[i]=='"'){field+='"'; i++;} else inQ=false; } else field+=ch; }
      else { if(ch=='"') inQ=true; else if(ch==',') pushF(); else if(ch=='\r'){} else if(ch=='\n'){ pushF(); pushR(); } else field+=ch; }
    }
    pushF(); if(row.length) pushR();
    if(rows.length<2) return [];
    const headers = rows[0].map(normalizeKey);
    const out=[];
    for(let r=1;r<rows.length;r++){
      const line=rows[r]; if(!line.some(v=>v && String(v).trim()!=='')) continue;
      const obj={}; headers.forEach((k,idx)=> obj[k]=(line[idx]||'').toString());
      out.push(obj);
    }
    return out;
  }

  function parseGviz(txt){
    const json = JSON.parse(txt.replace(/^[^{]+/,'').replace(/;?\s*$/,''));
    const cols = (json.table.cols||[]).map(c=>normalizeKey(c.label));
    const rows = json.table.rows || [];
    const out=[];
    for(const r of rows){
      const cells = r.c || []; const obj={};
      cols.forEach((key,i)=> obj[key] = cells[i] ? (cells[i].v != null ? String(cells[i].v) : '') : '');
      out.push(obj);
    }
    return out;
  }

  // Only cache-bust HTTP(S); do not modify data: or blob:
  async function fetchText(url){
    const u = new URL(url, location.href);
    const proto = u.protocol;
    if (proto === 'http:' || proto === 'https:') {
      u.searchParams.set('cb', String(Date.now()));
    }
    const res = await fetch(u.toString(), { cache: 'no-cache' });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const txt = await res.text();

    // If we accidentally got HTML, surface a clear message
    if (/^\s*</.test(txt)) {
      throw new Error('Received HTML instead of CSV/JSON — check Publish to web / sharing.');
    }
    return txt;
  }

  // Accept both encoded and unencoded CSV links; rebuild extras if needed
  function getCsvUrlFromParams(params){
    let url = params.get('csv');
    if (!url) return null;
    // If user pasted unencoded CSV, gid/single/output got split into separate params.
    if (url && !url.includes('?')) {
      const extras = [];
      ['gid','single','output'].forEach(k => {
        const v = params.get(k);
        if (v != null) extras.push(`${k}=${encodeURIComponent(v)}`);
      });
      if (extras.length) url += '?' + extras.join('&');
    }
    return url;
  }

  function mapRow(obj){
    const name = obj.name || obj['Name'] || '';
    const category = obj.category || obj['Category'] || '';
    const location = obj.location || obj['Location'] || '';
    const status = normStatus(obj.status || obj['Status'] || 'operational');
    const hazard = normHazard(obj.hazard_class || obj['Hazard Class'] || '0');
    const usage = obj.access || obj['Access'] || '';
    const image = obj.thumbnail_url || obj['Thumbnail URL'] || '';
    const detail = obj.detail_url || obj['Detail URL'] || '';
    const specs = parseSpecsCell(obj.specs || obj['Specs'] || '');
    return { name, category, location, status, hazard, usage, image, detail, specs };
  }

  // State
  let ALL_TOOLS = [];
  let categorySel = 'All';
  const statusSel = new Set(); // 'operational' | 'limited' | 'out' | 'setup'

  // Chip HTML generator (subtle translucent fills & borders)
  function chipHTML({label, color, glow, selected, button}){
    const bg = withAlpha(color, 0.12), bd = withAlpha(color, 0.25);
    const selAttr = selected ? ' data-selected="1"' : '';
    const cls = 'chip' + (button? ' btn':'');
    const dot = glow ? `<span class="dot live" style="color:${esc(color)}"></span>` : '';
    return `<span class="${cls}"${selAttr} style="color:${esc(color)}; background:${bg}; border-color:${bd}">${dot}${esc(label)}</span>`;
  }

  function renderFilters(){
    // Categories
    const cats = uniq(ALL_TOOLS.map(t=>t.category).filter(Boolean)).sort(sortStr);
    const catEls = ['All', ...cats].map(c => {
      const html = chipHTML({label:c, color:BRAND.aqua, glow:false, selected:(categorySel===c), button:true});
      return `<button type="button" class="cat" data-cat="${esc(c)}" style="all:unset">${html}</button>`;
    }).join('');
    document.getElementById('catChips').innerHTML = catEls;

    // Status chips
    const statuses = ['operational','limited','out','setup'];
    const statEls = statuses.map(k => {
      const meta = STATUS_META[k];
      const html = chipHTML({label:meta.label, color:meta.color, glow:false, selected:statusSel.has(k), button:true});
      return `<button type="button" class="stat" data-stat="${k}" style="all:unset">${html}</button>`;
    }).join('');
    document.getElementById('statChips').innerHTML = statEls;

    // Handlers
    document.querySelectorAll('button.cat').forEach(btn => {
      btn.onclick = () => { categorySel = btn.getAttribute('data-cat'); renderAll(); };
    });
    document.querySelectorAll('button.stat').forEach(btn => {
      btn.onclick = () => {
        const k = btn.getAttribute('data-stat');
        if (statusSel.has(k)) statusSel.delete(k); else statusSel.add(k);
        renderAll();
      };
    });
    document.getElementById('clearBtn').onclick = () => { categorySel='All'; statusSel.clear(); renderAll(); };
  }

  function renderGrid(list){
    els.count.textContent = `Showing ${list.length} of ${ALL_TOOLS.length}`;
    if (!list.length){
      els.grid.innerHTML = `<div class="item"><div class="card pad muted" style="text-align:center">No tools match your filters.</div></div>`;
      return;
    }
    const cards = list.map(t => {
      const stat = STATUS_META[t.status] || STATUS_META.operational;
      const haz = HAZARD_META[t.hazard];

      const img = t.image ? `<div class="imgwrap"><img src="${esc(t.image)}" alt="${esc(t.name)} photo" loading="lazy"></div>` : `<div class="imgwrap"></div>`;

      // Status chip has the animated live glow
      const statusChip = chipHTML({label:stat.label, color:stat.color, glow:true});
      const hazardChip = haz ? chipHTML({label:haz.label, color:haz.color, glow:false}) : '';
      const usageChip = t.usage ? chipHTML({label:t.usage, color:BRAND.aqua, glow:false}) : '';

      const specRows = (t.specs||[]).slice(0,3).map(([k,v]) =>
        `<div class="kv"><span class="k">${esc(k)}:</span><span class="v">${esc(v)}</span></div>`
      ).join('');

      const inner = `
        <article class="tool card pad" aria-label="${esc(t.name)}">
          ${img}
          <div class="row" style="align-items:flex-start; gap:12px">
            <div style="min-width:0">
              <div class="meta">${esc(t.category||'')}</div>
              <h3 class="line-clamp-1">${esc(t.name)}</h3>
              <div class="meta">${esc(t.location||'')}</div>
            </div>
            <div style="display:flex; flex-direction:column; gap:6px; align-items:flex-end">
              ${statusChip}
              ${hazardChip}
            </div>
          </div>
          ${specRows ? `<div class="kvs">${specRows}</div>` : ''}
          <div class="chips" style="margin-top:8px">${usageChip}</div>
        </article>`;

      const content = t.detail
        ? `<a class="cardlink" href="${esc(t.detail)}" target="_blank" rel="noopener">${inner}</a>`
        : inner;

      return `<div class="item">${content}</div>`;
    }).join('');

    els.grid.innerHTML = cards;
  }

  function renderAll(){
    renderFilters();
    const list = ALL_TOOLS.filter(t => {
      if (categorySel !== 'All' && t.category !== categorySel) return false;
      if (statusSel.size && !statusSel.has(t.status)) return false;
      return true;
    });
    renderGrid(list);
  }

  // Load data from ?csv= or ?sheet=&gid=
  (async function load(){
    try{
      const params = new URLSearchParams(location.search);
      const csvParam = getCsvUrlFromParams(params);
      const sheet = params.get('sheet');
      const gid = params.get('gid');
      const sheetName = params.get('sheetName');

      let rows = [];
      if (csvParam){
        const txt = await fetchText(csvParam);
        // Headers-only guard
        const lines = txt.replace(/\r/g,'').split('\n').filter(Boolean);
        if (lines.length <= 1) {
          throw new Error('CSV has headers but no data rows — republish the correct tab/range.');
        }
        rows = parseCSV(txt);
      } else if (sheet && (gid || sheetName)){
        let url = `https://docs.google.com/spreadsheets/d/${encodeURIComponent(sheet)}/gviz/tq?tqx=out:json`;
        if (gid) url += `&gid=${encodeURIComponent(gid)}`;
        if (sheetName) url += `&sheet=${encodeURIComponent(sheetName)}`;
        const txt = await fetchText(url);
        rows = parseGviz(txt);
      } else {
        els.grid.innerHTML = `<div class="item"><div class="card pad muted" style="text-align:center">Pass <code>?sheet=…&gid=…</code> or <code>?csv=…</code> in the URL.</div></div>`;
        els.count.textContent = `Showing 0 of 0`;
        return;
      }

      ALL_TOOLS = rows.map(mapRow);
      renderAll();
    }catch(err){
      console.error(err);
      els.grid.innerHTML = `<div class="item"><div class="card pad" style="border-left:6px solid var(--red)"><div class="error"><b>Failed to load data.</b> ${esc(err.message || '')} Ensure the tab is <b>Published to the web</b> and the URL params are correct.</div></div></div>`;
      els.count.textContent = `Showing 0 of 0`;
    }
  })();
})();
</script>
</body>
</html>
