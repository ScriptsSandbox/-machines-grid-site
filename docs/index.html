<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Explore Tools</title>

  <!-- Inter font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --aqua:#00C6D7;     /* brand aqua */
      --green:#6E963B;    /* operational */
      --yellow:#F3E500;   /* warn/hazard tint */
      --orange:#F59E0B;   /* limited */
      --red:#EF4444;      /* out-of-service */
      --text:#0F172A;
      --edge:#E2E8F0;
    }
    html,body{
      margin:0; padding:0; background:#747678; color:var(--text);
      font:16px/1.45 Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
    }
    .wrap{max-width:1180px;margin:0 auto;padding:24px 16px 56px}

    /* Card + UI */
    .card{background:#fff; border:1px solid var(--edge); border-radius:16px; box-shadow:0 8px 14px rgba(0,0,0,.05)}
    .pad{ padding:16px }
    .muted{ color:#64748B }
    .error{ color:#B91C1C }

    /* Filters */
    .filters h2{ margin:0 0 2px 0; font-size:1.5rem; letter-spacing:.2px }
    .row{ display:flex; gap:8px; align-items:center; justify-content:space-between }
    .chips{ display:flex; flex-wrap:wrap; gap:8px }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      font-size:.8rem; font-weight:600; line-height:1;
      padding:8px 12px; border-radius:9999px; user-select:none; cursor:default;
      border:1px solid rgba(0,0,0,.08);
      background:#fff; color:var(--text);
    }
    .chip.btn{ cursor:pointer }
    .chip[data-selected="1"]{ outline:3px solid var(--aqua); outline-offset:1px }

    /* Subtle live glow on status dot */
    .chip .dot{
      width:9px; height:9px; border-radius:50%;
      background: currentColor; position: relative;
    }
    .chip .dot.live{ animation: dotPulse 2.4s ease-in-out infinite }
    .chip .dot.live::after{
      content:""; position:absolute; inset:-5px; border-radius:50%;
      background: currentColor; opacity:.22; filter:saturate(1.1);
      animation: dotRing 2.4s ease-in-out infinite;
    }
    @keyframes dotPulse{ 0%,100%{ transform:scale(1) } 50%{ transform:scale(1.12) } }
    @keyframes dotRing { 0%{ transform:scale(.85); opacity:.22 } 70%{ transform:scale(1.35); opacity:0 } 100%{ transform:scale(.85); opacity:0 } }
    @media (prefers-reduced-motion: reduce){
      .chip .dot.live, .chip .dot.live::after{ animation:none }
    }

    /* Tool cards */
    .tool{ display:flex; flex-direction:column; gap:8px; transition: box-shadow .2s ease }
    .tool:hover{ box-shadow:0 12px 18px rgba(0,0,0,.07) }
    .imgwrap{ overflow:hidden; border-radius:12px; height:160px; background:#e5e7eb }
    .imgwrap img{ width:100%; height:100%; object-fit:cover; display:block }
    .tool h3{ font-size:1.05rem; margin:2px 0 0 0 }
    .meta{ font-size:.85rem; color:#64748B }
    .specs{ display:grid; gap:6px; margin-top:6px; font-size:.95rem; color:#0f172a }
    .spec-line{ white-space:pre-wrap }
    a.cardlink{ color:inherit; text-decoration:none }
    .line-clamp-1{ display:-webkit-box; -webkit-line-clamp:1; -webkit-box-orient:vertical; overflow:hidden }

    /* Masonry layout */
    .masonry{ column-width: 320px; column-gap:16px }
    @media (max-width: 640px){ .masonry{ column-width: 100% } }
    .masonry .item{ break-inside: avoid; margin:0 0 16px }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Filters -->
    <div class="card pad filters">
      <div class="row" style="align-items:flex-start">
        <div>
          <h2>Explore Tools</h2>
          <div id="count" class="muted" style="margin-top:4px; font-size:.95rem">Loading…</div>
        </div>
        <button id="clearBtn" class="chip btn">Clear</button>
      </div>

      <div style="margin-top:10px; font-size:.9rem; color:#475569">Categories</div>
      <div id="catChips" class="chips" style="margin-top:6px"></div>

      <div style="margin-top:10px; font-size:.9rem; color:#475569">Status</div>
      <div id="statChips" class="chips" style="margin-top:6px"></div>
    </div>

    <!-- Masonry grid -->
    <div id="grid" class="masonry" aria-live="polite" style="margin-top:16px"></div>

    <footer style="margin-top:24px; font-size:.9rem; color:#E5E7EB">
      © <span id="year"></span> SIO • Sandbox Makerspace • Built for clarity and quick access
    </footer>
  </div>

<script>
(function(){
  // Brand (for colors only)
  const BRAND = { aqua:"#00C6D7", green:"#6E963B", yellow:"#F3E500", orange:"#F59E0B", red:"#EF4444" };

  const els = {
    year: document.getElementById('year'),
    count: document.getElementById('count'),
    grid: document.getElementById('grid'),
    catChips: document.getElementById('catChips'),
    statChips: document.getElementById('statChips'),
    clearBtn: document.getElementById('clearBtn')
  };
  els.year.textContent = new Date().getFullYear();

  // Utils
  function esc(s){ return (s==null?'':String(s)).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
  function hexToRgb(hex){ const h=hex.replace('#',''); const n=parseInt(h,16); return {r:(n>>16)&255,g:(n>>8)&255,b:n&255}; }
  function withAlpha(hex,a){ const {r,g,b}=hexToRgb(hex); return `rgba(${r},${g},${b},${a})`; }
  function uniq(a){ return [...new Set(a)]; }
  function sortStr(a,b){ return String(a).localeCompare(String(b)); }

  // Status/hazard color only (labels come straight from sheet)
  function statusColor(s){
    const v=String(s||'').toLowerCase();
    if (/(down|offline|out\s*of\s*service)/.test(v)) return BRAND.red;
    if (/(restricted|limited)/.test(v)) return BRAND.orange;
    if (/(setup|commission)/.test(v)) return BRAND.aqua;
    return BRAND.green;
  }
  function hazardColor(h){
    const v=String(h||'').trim().toLowerCase();
    if (v==='3' || v==='hc-3') return BRAND.red;
    if (v==='2' || v==='hc-2') return BRAND.yellow;
    if (v==='1' || v==='hc-1') return BRAND.green;
    return 'rgba(148,163,184,.8)'; // neutral
  }

  // Parse Specs without injecting words; show up to 3 lines from the sheet
  function linesFromSpecs(specs){
    const txt = String(specs||'').replace(/\r/g,'').trim();
    if (!txt) return [];
    return txt.split('\n').map(s=>s.trim()).filter(Boolean).slice(0,3);
  }

  // CSV / GViz helpers
  function normalizeKey(k){ return String(k||'').trim().toLowerCase().replace(/\s+/g,'_'); }
  function parseCSV(text){
    const rows=[]; let i=0, field='', row=[], inQ=false;
    function pushF(){ row.push(field); field=''; }
    function pushR(){ rows.push(row); row=[]; }
    while(i<text.length){
      const ch=text[i++]; if(inQ){ if(ch=='"'){ if(text[i]=='"'){field+='"'; i++;} else inQ=false; } else field+=ch; }
      else { if(ch=='"') inQ=true; else if(ch==',') pushF(); else if(ch=='\r'){} else if(ch=='\n'){ pushF(); pushR(); } else field+=ch; }
    }
    pushF(); if(row.length) pushR();
    if(rows.length<2) return [];
    const headers = rows[0].map(normalizeKey);
    const out=[];
    for(let r=1;r<rows.length;r++){
      const line=rows[r]; if(!line.some(v=>v && String(v).trim()!=='')) continue;
      const obj={}; headers.forEach((k,idx)=> obj[k]=(line[idx]||'').toString());
      out.push(obj);
    }
    return out;
  }
  function parseGviz(txt){
    const json = JSON.parse(txt.replace(/^[^{]+/,'').replace(/;?\s*$/,''));
    const cols = (json.table.cols||[]).map(c=>normalizeKey(c.label));
    const rows = json.table.rows || [];
    const out=[];
    for(const r of rows){
      const cells = r.c || []; const obj={};
      cols.forEach((key,i)=> obj[key] = cells[i] ? (cells[i].v != null ? String(cells[i].v) : '') : '');
      out.push(obj);
    }
    return out;
  }

  // Only cache-bust http(s); not data:/blob:
  async function fetchText(url){
    const u = new URL(url, location.href);
    if (u.protocol === 'http:' || u.protocol === 'https:') u.searchParams.set('cb', String(Date.now()));
    const res = await fetch(u.toString(), { cache: 'no-cache' });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const txt = await res.text();
    if (/^\s*</.test(txt)) throw new Error('Received HTML instead of CSV/JSON — check Publish to web / sharing.');
    return txt;
  }

  function getCsvUrlFromParams(params){
    let url = params.get('csv');
    if (!url) return null;
    // Rebuild extras if user pasted unencoded link and WP split params
    if (!url.includes('?')) {
      const extras=[]; ['gid','single','output'].forEach(k=>{ const v=params.get(k); if(v!=null) extras.push(`${k}=${encodeURIComponent(v)}`); });
      if (extras.length) url += '?' + extras.join('&');
    }
    return url;
  }

  // ***** DATA MAPPING: show MODEL (prefer "Model" col; fallback to "Location") *****
  function mapRow(obj){
    const name = obj.name || obj['Name'] || '';
    const category = obj.category || obj['Category'] || '';
    // Prefer explicit Model column; otherwise reuse Location column for model text
    const model = obj.model || obj['Model'] || obj.location || obj['Location'] || '';
    const statusTxt = obj.status || obj['Status'] || '';
    const hazardTxt = obj.hazard_class || obj['Hazard Class'] || '';
    const access = obj.access || obj['Access'] || '';
    const accessChips = (obj.access_chips || obj['Access Chips'] || '').split(/[;,]/).map(s=>s.trim()).filter(Boolean);
    const image = obj.thumbnail_url || obj['Thumbnail URL'] || '';
    const detail = obj.detail_url || obj['Detail URL'] || '';
    const description = obj.description || obj['Description'] || '';
    const specs = obj.specs || obj['Specs'] || '';

    return {
      name, category, model,
      statusTxt, hazardTxt, access, accessChips,
      image, detail, description, specs,
      statusColor: statusColor(statusTxt),
      hazardColor: hazardColor(hazardTxt)
    };
  }

  // State
  let ALL_TOOLS = [];
  let categorySel = 'All';
  const statusSel = new Set(); // values are normalized for color, but we match against sheet text via contains

  function chipHTML({label, color, glow, selected, button}){
    const bg = withAlpha(color, 0.12), bd = withAlpha(color, 0.25);
    const selAttr = selected ? ' data-selected="1"' : '';
    const cls = 'chip' + (button? ' btn':'');
    const dot = glow ? `<span class="dot live" style="color:${esc(color)}"></span>` : '';
    return `<span class="${cls}"${selAttr} style="color:${esc(color)}; background:${bg}; border-color:${bd}">${dot}${esc(label)}</span>`;
  }

  function renderFilters(){
    // Categories from data
    const cats = uniq(ALL_TOOLS.map(t=>t.category).filter(Boolean)).sort(sortStr);
    const catEls = ['All', ...cats].map(c => {
      const html = chipHTML({label:c, color:BRAND.aqua, glow:false, selected:(categorySel===c), button:true});
      return `<button type="button" class="cat" data-cat="${esc(c)}" style="all:unset">${html}</button>`;
    }).join('');
    els.catChips.innerHTML = catEls;

    // Fixed status filter chips (labels only; we filter by substring match)
    const STATUS_FILTERS = [
      {key:'operational', label:'Operational', color:BRAND.green},
      {key:'limited', label:'Limited', color:BRAND.orange},
      {key:'out', label:'Out of Service', color:BRAND.red},
      {key:'setup', label:'In Setup', color:BRAND.aqua},
    ];
    const statEls = STATUS_FILTERS.map(f => {
      const html = chipHTML({label:f.label, color:f.color, glow:false, selected:statusSel.has(f.key), button:true});
      return `<button type="button" class="stat" data-stat="${f.key}" style="all:unset">${html}</button>`;
    }).join('');
    els.statChips.innerHTML = statEls;

    // Handlers
    els.catChips.querySelectorAll('button.cat').forEach(btn => {
      btn.onclick = () => { categorySel = btn.getAttribute('data-cat'); renderAll(); };
    });
    els.statChips.querySelectorAll('button.stat').forEach(btn => {
      btn.onclick = () => {
        const k = btn.getAttribute('data-stat');
        if (statusSel.has(k)) statusSel.delete(k); else statusSel.add(k);
        renderAll();
      };
    });
    els.clearBtn.onclick = () => { categorySel='All'; statusSel.clear(); renderAll(); };
  }

  function renderGrid(list){
    els.count.textContent = `Showing ${list.length} of ${ALL_TOOLS.length}`;
    if (!list.length){
      els.grid.innerHTML = `<div class="item"><div class="card pad muted" style="text-align:center">No tools match your filters.</div></div>`;
      return;
    }
    const cards = list.map(t => {
      // Chips: labels are exactly what’s in the sheet
      const statusChip = chipHTML({label:t.statusTxt, color:t.statusColor, glow:true});
      const hazardChip = t.hazardTxt ? chipHTML({label:t.hazardTxt, color:t.hazardColor, glow:false}) : '';
      const accessChip = t.access ? chipHTML({label:t.access, color:BRAND.aqua, glow:false}) : '';
      const extraAccess = (t.accessChips||[]).map(c => chipHTML({label:c, color:BRAND.aqua, glow:false})).join('');

      const specLines = linesFromSpecs(t.specs).map(line => `<div class="spec-line">${esc(line)}</div>`).join('');

      const body = `
        <article class="tool card pad" aria-label="${esc(t.name)}">
          ${t.image ? `<div class="imgwrap"><img src="${esc(t.image)}" alt="${esc(t.name)} photo" loading="lazy"></div>` : `<div class="imgwrap"></div>`}
          <div class="row" style="align-items:flex-start; gap:12px">
            <div style="min-width:0">
              <div class="meta">${esc(t.category||'')}</div>
              <h3 class="line-clamp-1">${esc(t.name)}</h3>
              <div class="meta">${esc(t.model||'')}</div>
            </div>
            <div style="display:flex; flex-direction:column; gap:6px; align-items:flex-end">
              ${statusChip}
              ${hazardChip}
            </div>
          </div>
          ${t.description ? `<div class="muted" style="margin-top:6px; white-space:pre-wrap">${esc(t.description)}</div>` : ''}
          ${specLines ? `<div class="specs">${specLines}</div>` : ''}
          ${(accessChip || extraAccess) ? `<div class="chips" style="margin-top:8px">${accessChip}${extraAccess}</div>` : ''}
        </article>
      `;

      return `<div class="item">${ t.detail ? `<a class="cardlink" href="${esc(t.detail)}" target="_blank" rel="noopener">${body}</a>` : body }</div>`;
    }).join('');
    els.grid.innerHTML = cards;
  }

  function renderAll(){
    renderFilters();
    const list = ALL_TOOLS.filter(t => {
      if (categorySel !== 'All' && t.category !== categorySel) return false;
      if (statusSel.size){
        const want = Array.from(statusSel);
        const s = t.statusTxt.toLowerCase();
        const match =
          (want.includes('operational') && /operational/.test(s)) ||
          (want.includes('limited') && /(restricted|limited)/.test(s)) ||
          (want.includes('out') && /(down|offline|out\s*of\s*service)/.test(s)) ||
          (want.includes('setup') && /(setup|commission)/.test(s));
        if (!match) return false;
      }
      return true;
    });
    renderGrid(list);
  }

  // Load from ?csv= (preferred) or ?sheet=&gid=
  (async function load(){
    try{
      const params = new URLSearchParams(location.search);
      const csvParam = getCsvUrlFromParams(params);
      const sheet = params.get('sheet');
      const gid = params.get('gid');
      const sheetName = params.get('sheetName');

      let rows = [];
      if (csvParam){
        const txt = await fetchText(csvParam);
        const lines = txt.replace(/\r/g,'').split('\n').filter(Boolean);
        if (lines.length <= 1) throw new Error('CSV has headers but no data rows — republish the correct tab.');
        rows = parseCSV(txt);
      } else if (sheet && (gid || sheetName)){
        let url = `https://docs.google.com/spreadsheets/d/${encodeURIComponent(sheet)}/gviz/tq?tqx=out:json`;
        if (gid) url += `&gid=${encodeURIComponent(gid)}`;
        if (sheetName) url += `&sheet=${encodeURIComponent(sheetName)}`;
        const txt = await fetchText(url);
        rows = parseGviz(txt);
      } else {
        els.grid.innerHTML = `<div class="item"><div class="card pad muted" style="text-align:center">Pass <code>?sheet=…&gid=…</code> or <code>?csv=…</code> in the URL.</div></div>`;
        els.count.textContent = `Showing 0 of 0`;
        return;
      }

      ALL_TOOLS = rows.map(mapRow);
      renderAll();
    }catch(err){
      console.error(err);
      els.grid.innerHTML = `<div class="item"><div class="card pad" style="border-left:6px solid var(--red)"><div class="error"><b>Failed to load data.</b> ${esc(err.message||'')} Ensure the tab is <b>Published to the web</b> and the URL params are correct.</div></div></div>`;
      els.count.textContent = `Showing 0 of 0`;
    }
  })();
})();
</script>
</body>
</html>
