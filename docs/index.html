<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Explore Tools</title>

  <!-- Inter font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --aqua:#00C6D7;     /* brand aqua */
      --green:#6E963B;    /* operational */
      --yellow:#F3E500;   /* warn/hazard tint */
      --orange:#F59E0B;   /* limited */
      --red:#EF4444;      /* out-of-service */
      --text:#0F172A;
      --edge:#E2E8F0;
      --bg:#747678;
    }
    html,body{
      margin:0; padding:0; background:var(--bg); color:var(--text);
      font:16px/1.45 Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
    }
    .wrap{max-width:1180px;margin:0 auto;padding:24px 16px 56px}

    /* Card + UI */
    .card{background:#fff; border:1px solid var(--edge); border-radius:16px; box-shadow:0 8px 14px rgba(0,0,0,.05)}
    .pad{ padding:16px }
    .muted{ color:#64748B }
    .error{ color:#B91C1C }

    /* Filters */
    .filters h2{ margin:0 0 2px 0; font-size:1.5rem; letter-spacing:.2px }
    .row{ display:flex; gap:8px; align-items:center; justify-content:space-between }
    .chips{ display:flex; flex-wrap:wrap; gap:8px }
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      font-size:.8rem; font-weight:600; line-height:1;
      padding:8px 12px; border-radius:9999px; user-select:none; cursor:default;
      border:1px solid rgba(0,0,0,.08);
      background:#fff; color:var(--text);
    }
    .chip.btn{ cursor:pointer }
    .chip[data-selected="1"]{ outline:3px solid var(--aqua); outline-offset:1px }

    /* Subtle live glow on status dot */
    .chip .dot{
      width:9px; height:9px; border-radius:50%;
      background: currentColor; position: relative;
    }
    .chip .dot.live{ animation: dotPulse 2.4s ease-in-out infinite }
    .chip .dot.live::after{
      content:""; position:absolute; inset:-5px; border-radius:50%;
      background: currentColor; opacity:.22; filter:saturate(1.1);
      animation: dotRing 2.4s ease-in-out infinite;
    }
    @keyframes dotPulse{ 0%,100%{ transform:scale(1) } 50%{ transform:scale(1.12) } }
    @keyframes dotRing { 0%{ transform:scale(.85); opacity:.22 } 70%{ transform:scale(1.35); opacity:0 } 100%{ transform:scale(.85); opacity:0 } }
    @media (prefers-reduced-motion: reduce){
      .chip .dot.live, .chip .dot.live::after{ animation:none }
    }

    /* DEFAULT Tool cards (your current layout) */
    .tool{ display:flex; flex-direction:column; gap:8px; transition: box-shadow .2s ease }
    .tool:hover{ box-shadow:0 12px 18px rgba(0,0,0,.07) }
    .imgwrap{ overflow:hidden; border-radius:12px; height:160px; background:#e5e7eb }
    .imgwrap img{ width:100%; height:100%; object-fit:cover; display:block }
    .tool h3{ font-size:1.05rem; margin:2px 0 0 0 }
    .meta{ font-size:.85rem; color:#64748B }
    .specs{ display:grid; gap:6px; margin-top:6px; font-size:.95rem; color:#0f172a }
    .spec-line{ white-space:pre-wrap }
    a.cardlink{ color:inherit; text-decoration:none }
    .line-clamp-1{ display:-webkit-box; -webkit-line-clamp:1; -webkit-box-orient:vertical; overflow:hidden }

    /* Masonry layout */
    .masonry{ column-width: 320px; column-gap:16px }
    @media (max-width: 640px){ .masonry{ column-width: 100% } }
    .masonry .item{ break-inside: avoid; margin:0 0 16px }

    /* PIER layout */
    .masonry[data-layout="pier"]{ column-width: 420px; }
    @media (max-width: 900px){ .masonry[data-layout="pier"]{ column-width: 100% } }

    .pier-card{
      border-radius:28px;
      overflow:hidden;
    }
    .pier-hero{
      background:#efefef;
      padding:14px 14px 0 14px;
    }
    .pier-hero-frame{
      border-radius:22px;
      background:#dcdcdc;
      padding:14px;
      position:relative;
      overflow:hidden;
    }
    .pier-hero-frame::before,
    .pier-hero-frame::after{
      content:"";
      position:absolute;
      top:12px; bottom:12px;
      width:14px;
      border-radius:14px;
      background:rgba(255,255,255,.55);
    }
    .pier-hero-frame::before{ left:10px; }
    .pier-hero-frame::after{ right:10px; }
    .pier-hero-img{
      height:220px;
      border-radius:18px;
      overflow:hidden;
      background:#cbd5e1;
    }
    .pier-hero-img img{
      width:100%; height:100%;
      object-fit:cover;
      display:block;
    }

    .pier-body{
      padding:16px 18px 18px 18px;
    }
    .pier-top{
      display:flex;
      gap:12px;
      align-items:flex-start;
      justify-content:space-between;
      margin-top:12px;
    }
    .pier-tags{
      display:flex;
      flex-direction:column;
      gap:8px;
      min-width:0;
    }
    .pier-tag{
      display:inline-block;
      align-self:flex-start;
      background:#f3f4f6;
      border:1px solid #e5e7eb;
      border-radius:10px;
      padding:8px 10px;
      font-weight:700;
      color:#111827;
      max-width:100%;
    }
    .pier-tag.big{ font-size:1.25rem; line-height:1.1; }
    .pier-tag.small{ font-size:1rem; font-weight:700; }

    .pier-right{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:10px;
      flex:0 0 auto;
    }
    .pier-status{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 14px;
      border-radius:9999px;
      font-weight:700;
      border:1px solid rgba(0,0,0,.08);
      background:#fff;
      white-space:nowrap;
    }
    .pier-status .dot{
      width:10px;
      height:10px;
      border-radius:50%;
      background: currentColor;
    }
    .pier-chart{
      width:190px;
      height:120px;
      border-radius:12px;
      overflow:hidden;
      background:#f1f5f9;
      border:1px solid #e5e7eb;
    }
    .pier-chart img{ width:100%; height:100%; object-fit:cover; display:block; }

    .pier-title{
      font-size:1.75rem;
      margin:14px 0 10px 0;
      letter-spacing:.1px;
    }

    .pier-mid{
      display:grid;
      grid-template-columns: 1fr 220px;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 520px){
      .pier-mid{ grid-template-columns: 1fr; }
      .pier-right{ align-items:flex-start; }
      .pier-chart{ width:100%; }
    }

    .pier-section-title{
      font-size:1.1rem;
      font-weight:800;
      margin:8px 0 8px 0;
    }
    .pier-range{
      border-top:1px solid #e5e7eb;
      padding-top:8px;
    }
    .pier-range-table{
      border:1px solid #e5e7eb;
      border-radius:12px;
      overflow:hidden;
      background:#fff;
    }
    .pier-range-row{
      padding:10px 12px;
      border-top:1px solid #e5e7eb;
      font-weight:600;
      text-align:center;
    }
    .pier-range-row:first-child{ border-top:none; }

    .pier-aux{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .pier-aux-table{
      border:1px solid #e5e7eb;
      border-radius:12px;
      overflow:hidden;
      background:#f3f4f6;
    }
    .pier-aux-grid{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      text-align:center;
    }
    .pier-aux-cell{
      padding:12px 8px;
      border-left:1px solid #e5e7eb;
    }
    .pier-aux-cell:first-child{ border-left:none; }
    .pier-aux-h{
      font-size:1.2rem;
      font-weight:900;
    }
    .pier-aux-v{
      font-size:2rem;
      font-weight:900;
      margin-top:8px;
    }

    .pier-dates{
      display:flex;
      gap:12px;
      margin-top:14px;
      flex-wrap:wrap;
    }
    .date-pill{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:12px 16px;
      border-radius:9999px;
      border:2px solid rgba(0,0,0,.06);
      font-weight:900;
      font-size:1.4rem;
      min-width:160px;
    }
    .date-pill.green{
      background: rgba(110,150,59,.18);
      color:#111827;
    }
    .date-pill.red{
      background: rgba(239,68,68,.22);
      color:#111827;
    }
    .date-label{
      font-size:.85rem;
      font-weight:700;
      color:#6b7280;
      margin:0 0 6px 6px;
    }
    .date-wrap{ display:flex; flex-direction:column; }

    .pier-link{
      display:flex;
      gap:10px;
      align-items:center;
      margin-top:14px;
      font-size:1.05rem;
      font-weight:700;
      color:#2563eb;
      overflow:hidden;
    }
    .pier-link .icon{
      width:26px; height:26px;
      border-radius:9999px;
      background:#e0f2fe;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#0369a1;
      flex:0 0 auto;
    }
    .pier-link a{
      color:inherit;
      text-decoration:none;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      display:block;
      min-width:0;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Filters -->
    <div class="card pad filters">
      <div class="row" style="align-items:flex-start">
        <div>
          <h2 id="pageTitle">Explore Tools</h2>
          <div id="count" class="muted" style="margin-top:4px; font-size:.95rem">Loading…</div>
        </div>
        <button id="clearBtn" class="chip btn">Clear</button>
      </div>

      <div style="margin-top:10px; font-size:.9rem; color:#475569">Categories</div>
      <div id="catChips" class="chips" style="margin-top:6px"></div>

      <div style="margin-top:10px; font-size:.9rem; color:#475569">Status</div>
      <div id="statChips" class="chips" style="margin-top:6px"></div>
    </div>

    <!-- Masonry grid -->
    <div id="grid" class="masonry" aria-live="polite" style="margin-top:16px"></div>

    <footer style="margin-top:24px; font-size:.9rem; color:#E5E7EB">
      © <span id="year"></span> SIO • Built for clarity and quick access
    </footer>
  </div>

<script>
(function(){
  // Brand (for colors only)
  const BRAND = { aqua:"#00C6D7", green:"#6E963B", yellow:"#F3E500", orange:"#F59E0B", red:"#EF4444" };

  const els = {
    year: document.getElementById('year'),
    count: document.getElementById('count'),
    grid: document.getElementById('grid'),
    catChips: document.getElementById('catChips'),
    statChips: document.getElementById('statChips'),
    clearBtn: document.getElementById('clearBtn'),
    pageTitle: document.getElementById('pageTitle')
  };
  els.year.textContent = new Date().getFullYear();

  // Utils
  function esc(s){ return (s==null?'':String(s)).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
  function hexToRgb(hex){ const h=hex.replace('#',''); const n=parseInt(h,16); return {r:(n>>16)&255,g:(n>>8)&255,b:n&255}; }
  function withAlpha(hex,a){ const {r,g,b}=hexToRgb(hex); return `rgba(${r},${g},${b},${a})`; }
  function uniq(a){ return [...new Set(a)]; }
  function sortStr(a,b){ return String(a).localeCompare(String(b)); }

  function normalizeKey(k){ return String(k||'').trim().toLowerCase().replace(/\s+/g,'_'); }
  function first(obj, keys){
    for (const k of keys){
      const nk = normalizeKey(k);
      const v = obj[nk] ?? obj[k];
      if (v != null && String(v).trim() !== '') return String(v).trim();
    }
    return '';
  }
  function splitLines(txt){
    const t = String(txt||'').replace(/\r/g,'').trim();
    if (!t) return [];
    // split on newlines OR semicolons that look like list separators
    const lines = t.includes('\n') ? t.split('\n') : t.split(';');
    return lines.map(s=>s.trim()).filter(Boolean);
  }
  function collectPrefix(obj, prefix){
    const p = normalizeKey(prefix);
    return Object.keys(obj)
      .filter(k => k.startsWith(p))
      .sort((a,b)=> a.localeCompare(b))
      .map(k => String(obj[k]||'').trim())
      .filter(Boolean);
  }
  function shortUrl(u){
    try{
      const url = new URL(u);
      const s = (url.host + url.pathname).replace(/\/$/,'');
      return s.length > 48 ? (s.slice(0,46) + '…') : s;
    }catch{
      return u.length > 48 ? (u.slice(0,46) + '…') : u;
    }
  }

  // Status/hazard color only (labels come straight from sheet)
  function statusColor(s){
    const v=String(s||'').toLowerCase();
    if (/(down|offline|out\s*of\s*service|broken|fail)/.test(v)) return BRAND.red;
    if (/(restricted|limited|degraded|partial)/.test(v)) return BRAND.orange;
    if (/(setup|commission|install|deploy)/.test(v)) return BRAND.aqua;
    return BRAND.green; // includes operational/ok/online
  }
  function hazardColor(h){
    const v=String(h||'').trim().toLowerCase();
    if (v==='3' || v==='hc-3') return BRAND.red;
    if (v==='2' || v==='hc-2') return BRAND.yellow;
    if (v==='1' || v==='hc-1') return BRAND.green;
    return 'rgba(148,163,184,.8)'; // neutral
  }

  // Parse Specs without injecting words; show up to 3 lines from the sheet
  function linesFromSpecs(specs){
    const txt = String(specs||'').replace(/\r/g,'').trim();
    if (!txt) return [];
    return txt.split('\n').map(s=>s.trim()).filter(Boolean).slice(0,3);
  }

  // CSV / GViz helpers
  function parseCSV(text){
    const rows=[]; let i=0, field='', row=[], inQ=false;
    function pushF(){ row.push(field); field=''; }
    function pushR(){ rows.push(row); row=[]; }
    while(i<text.length){
      const ch=text[i++];
      if(inQ){
        if(ch=='"'){
          if(text[i]=='"'){field+='"'; i++;} else inQ=false;
        } else field+=ch;
      } else {
        if(ch=='"') inQ=true;
        else if(ch==',') pushF();
        else if(ch=='\r'){}
        else if(ch=='\n'){ pushF(); pushR(); }
        else field+=ch;
      }
    }
    pushF(); if(row.length) pushR();
    if(rows.length<2) return [];
    const headers = rows[0].map(normalizeKey);
    const out=[];
    for(let r=1;r<rows.length;r++){
      const line=rows[r];
      if(!line.some(v=>v && String(v).trim()!=='')) continue;
      const obj={};
      headers.forEach((k,idx)=> obj[k]=(line[idx]||'').toString());
      out.push(obj);
    }
    return out;
  }
  function parseGviz(txt){
    const json = JSON.parse(txt.replace(/^[^{]+/,'').replace(/;?\s*$/,''));
    const cols = (json.table.cols||[]).map(c=>normalizeKey(c.label));
    const rows = json.table.rows || [];
    const out=[];
    for(const r of rows){
      const cells = r.c || []; const obj={};
      cols.forEach((key,i)=> obj[key] = cells[i] ? (cells[i].v != null ? String(cells[i].v) : '') : '');
      out.push(obj);
    }
    return out;
  }

  // Only cache-bust http(s); not data:/blob:
  async function fetchText(url){
    const u = new URL(url, location.href);
    if (u.protocol === 'http:' || u.protocol === 'https:') u.searchParams.set('cb', String(Date.now()));
    const res = await fetch(u.toString(), { cache: 'no-cache' });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const txt = await res.text();
    if (/^\s*</.test(txt)) throw new Error('Received HTML instead of CSV/JSON — check Publish to web / sharing.');
    return txt;
  }

  function getCsvUrlFromParams(params){
    let url = params.get('csv');
    if (!url) return null;
    // Rebuild extras if user pasted unencoded link and WP split params
    if (!url.includes('?')) {
      const extras=[]; ['gid','single','output'].forEach(k=>{ const v=params.get(k); if(v!=null) extras.push(`${k}=${encodeURIComponent(v)}`); });
      if (extras.length) url += '?' + extras.join('&');
    }
    return url;
  }

  // Layout + title params
  const params = new URLSearchParams(location.search);
  const LAYOUT = (params.get('layout') || 'tools').toLowerCase(); // tools | pier
  const TITLE = params.get('title') || (LAYOUT === 'pier' ? 'Pier Instrumentation' : 'Explore Tools');
  document.title = TITLE;
  els.pageTitle.textContent = TITLE;
  els.grid.dataset.layout = LAYOUT;

  // ***** DATA MAPPING (common fields for filters + linking) *****
  function mapRow(obj){
    const name = first(obj, ['name','title','instrument','station','asset']);
    const category = first(obj, ['category','instrument_category','type','domain']);
    const model = first(obj, ['model','location','site']);
    const statusTxt = first(obj, ['status','operational_status','state']);
    const hazardTxt = first(obj, ['hazard_class','hazard','hc']);
    const access = first(obj, ['access']);
    const accessChips = first(obj, ['access_chips']).split(/[;,]/).map(s=>s.trim()).filter(Boolean);

    const image = first(obj, ['thumbnail_url','thumbnail','photo_url','photo','image_url','image']);
    const detail = first(obj, ['detail_url','detail','link_url','url','data_url','link']);
    const description = first(obj, ['description','notes']);
    const specs = first(obj, ['specs','specifications','spec']);

    return {
      name, category, model,
      statusTxt, hazardTxt, access, accessChips,
      image, detail, description, specs,
      statusColor: statusColor(statusTxt),
      hazardColor: hazardColor(hazardTxt),
      _raw: obj
    };
  }

  // State
  let ALL_TOOLS = [];
  let categorySel = 'All';
  const statusSel = new Set(); // values are normalized buckets

  function chipHTML({label, color, glow, selected, button}){
    const bg = withAlpha(color, 0.12), bd = withAlpha(color, 0.25);
    const selAttr = selected ? ' data-selected="1"' : '';
    const cls = 'chip' + (button? ' btn':'');
    const dot = glow ? `<span class="dot live" style="color:${esc(color)}"></span>` : '';
    return `<span class="${cls}"${selAttr} style="color:${esc(color)}; background:${bg}; border-color:${bd}">${dot}${esc(label)}</span>`;
  }

  function renderFilters(){
    // Categories from data
    const cats = uniq(ALL_TOOLS.map(t=>t.category).filter(Boolean)).sort(sortStr);
    const catEls = ['All', ...cats].map(c => {
      const html = chipHTML({label:c, color:BRAND.aqua, glow:false, selected:(categorySel===c), button:true});
      return `<button type="button" class="cat" data-cat="${esc(c)}" style="all:unset">${html}</button>`;
    }).join('');
    els.catChips.innerHTML = catEls;

    // Fixed status filter chips
    const STATUS_FILTERS = [
      {key:'operational', label:'Operational', color:BRAND.green},
      {key:'limited', label:'Limited', color:BRAND.orange},
      {key:'out', label:'Out of Service', color:BRAND.red},
      {key:'setup', label:'In Setup', color:BRAND.aqua},
    ];
    const statEls = STATUS_FILTERS.map(f => {
      const html = chipHTML({label:f.label, color:f.color, glow:false, selected:statusSel.has(f.key), button:true});
      return `<button type="button" class="stat" data-stat="${f.key}" style="all:unset">${html}</button>`;
    }).join('');
    els.statChips.innerHTML = statEls;

    // Handlers
    els.catCh
